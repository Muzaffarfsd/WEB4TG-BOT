import logging
from typing import Optional, List, Dict

logger = logging.getLogger(__name__)


OBJECTION_PATTERNS = {
    "price": [
        "Ð´Ð¾Ñ€Ð¾Ð³Ð¾", "Ð´Ð¾Ñ€Ð¾Ð³Ð¾Ð²Ð°Ñ‚Ð¾", "ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ð´Ð¾Ñ€Ð¾Ð³Ð¾", "Ñ†ÐµÐ½Ð° ÐºÑƒÑÐ°ÐµÑ‚ÑÑ", "Ð½Ðµ Ð¿Ð¾Ñ‚ÑÐ½Ñƒ",
        "Ð±ÑŽÐ´Ð¶ÐµÑ‚ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½", "Ð½ÐµÑ‚ Ð±ÑŽÐ´Ð¶ÐµÑ‚Ð°", "Ð½Ðµ Ñ…Ð²Ð°Ñ‚Ð°ÐµÑ‚", "expensive", "costly",
        "Ð¼Ð½Ð¾Ð³Ð¾ Ð´ÐµÐ½ÐµÐ³", "Ð·Ð° Ñ‚Ð°ÐºÐ¸Ðµ Ð´ÐµÐ½ÑŒÐ³Ð¸", "Ð´ÐµÑˆÐµÐ²Ð»Ðµ", "cheaper", "Ð·Ð°Ð²Ñ‹ÑˆÐµÐ½",
        "Ð¿ÐµÑ€ÐµÐ¿Ð»Ð°Ñ‚Ð°", "Ð½Ðµ ÑÑ‚Ð¾Ð¸Ñ‚ ÑÑ‚Ð¾Ð»ÑŒÐºÐ¾", "could be cheaper", "too much",
        "Ð½ÐµÑ‚ Ñ‚Ð°ÐºÐ¸Ñ… Ð´ÐµÐ½ÐµÐ³", "Ð½Ðµ Ð¿Ð¾ ÐºÐ°Ñ€Ð¼Ð°Ð½Ñƒ", "Ð´Ð¾Ñ€Ð¾Ð³Ð¾Ð²Ð°Ñ‚"
    ],
    "delay": [
        "Ð¿Ð¾Ð´ÑƒÐ¼Ð°ÑŽ", "Ð½Ð°Ð´Ð¾ Ð¿Ð¾Ð´ÑƒÐ¼Ð°Ñ‚ÑŒ", "Ð¿Ð¾Ð·Ð¶Ðµ", "Ð½Ðµ ÑÐµÐ¹Ñ‡Ð°Ñ", "Ð¿Ð¾Ñ‚Ð¾Ð¼",
        "Ñ‡ÐµÑ€ÐµÐ· Ð¼ÐµÑÑÑ†", "Ñ‡ÐµÑ€ÐµÐ· Ð½ÐµÐ´ÐµÐ»ÑŽ", "Ð½Ð° Ð´Ð½ÑÑ…", "Ð² ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ Ñ€Ð°Ð·",
        "Ð¿Ð¾ÐºÐ° Ð½Ðµ Ð³Ð¾Ñ‚Ð¾Ð²", "ÐµÑ‰Ñ‘ Ñ€Ð°Ð½Ð¾", "Ñ€Ð°Ð½Ð¾ ÐµÑ‰Ñ‘", "think about it",
        "later", "not now", "need time", "Ð½ÑƒÐ¶Ð½Ð¾ Ð²Ñ€ÐµÐ¼Ñ", "Ð½Ðµ ÑÐ¿ÐµÑˆÑƒ"
    ],
    "competitor": [
        "Ñƒ ÐºÐ¾Ð½ÐºÑƒÑ€ÐµÐ½Ñ‚Ð¾Ð²", "Ð² Ð´Ñ€ÑƒÐ³Ð¾Ð¼ Ð¼ÐµÑÑ‚Ðµ", "Ð´Ñ€ÑƒÐ³Ð°Ñ ÑÑ‚ÑƒÐ´Ð¸Ñ", "Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð´ÐµÐ»Ð°ÑŽÑ‚",
        "Ð½Ð°ÑˆÑ‘Ð» Ð´ÐµÑˆÐµÐ²Ð»Ðµ", "Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°ÑŽÑ‚ Ð´ÐµÑˆÐµÐ²Ð»Ðµ", "ÐµÑÑ‚ÑŒ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹", "Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²",
        "freelancer", "Ñ„Ñ€Ð¸Ð»Ð°Ð½ÑÐµÑ€", "Ð½Ð° upwork", "fiverr", "ÐºÐ¾Ð½ÐºÑƒÑ€ÐµÐ½Ñ‚",
        "competitor", "someone else", "other company", "Ð´Ñ€ÑƒÐ³Ð¾Ð¹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº"
    ],
    "doubt": [
        "Ð½Ðµ ÑƒÐ²ÐµÑ€ÐµÐ½", "ÑÐ¾Ð¼Ð½ÐµÐ²Ð°ÑŽÑÑŒ", "Ð° Ñ‚Ð¾Ñ‡Ð½Ð¾", "Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¸", "Ð° ÐµÑÐ»Ð¸ Ð½Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑÑ",
        "Ð° Ð²Ð´Ñ€ÑƒÐ³", "Ñ€Ð¸ÑÐº", "ÑÑ‚Ñ€Ð°ÑˆÐ½Ð¾", "Ð±Ð¾ÑŽÑÑŒ", "Ð½Ðµ Ð·Ð½Ð°ÑŽ Ð½ÑƒÐ¶Ð½Ð¾ Ð»Ð¸",
        "ÑÑ‚Ð¾Ð¸Ñ‚ Ð»Ð¸", "worth it", "not sure", "doubt", "guarantee",
        "Ð° Ð·Ð°Ñ‡ÐµÐ¼", "Ð½ÑƒÐ¶Ð½Ð¾ Ð»Ð¸ Ð²Ð¾Ð¾Ð±Ñ‰Ðµ", "Ð¼Ð¾Ð¶ÐµÑ‚ Ð½Ðµ Ð½Ð°Ð´Ð¾"
    ],
    "trust": [
        "Ð° Ð²Ñ‹ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ", "Ð¼Ð¾ÑˆÐµÐ½Ð½Ð¸ÐºÐ¸", "ÐºÐ¸Ð½ÐµÑ‚Ðµ", "Ð¾Ð±Ð¼Ð°Ð½", "Ñ€Ð°Ð·Ð²Ð¾Ð´",
        "Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð²ÐµÑ€ÑÑ‚ÑŒ", "Ð¾Ñ‚Ð·Ñ‹Ð²Ñ‹ Ð½Ð°ÑÑ‚Ð¾ÑÑ‰Ð¸Ðµ", "scam", "fraud", "trust",
        "ÐºÑ‚Ð¾ Ð²Ñ‹", "ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ñ Ð½Ð°ÑÑ‚Ð¾ÑÑ‰Ð°Ñ", "Ð° ÐµÑÑ‚ÑŒ Ð¾Ñ„Ð¸Ñ", "ÑŽÑ€ Ð»Ð¸Ñ†Ð¾"
    ],
    "free": [
        "Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾", "Ð±ÐµÐ· Ð´ÐµÐ½ÐµÐ³", "Ð·Ð° 0", "free", "no cost",
        "Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ñ‹Ð¹", "ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ ÑÐ°Ð¼Ð¾Ð¼Ñƒ Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾", "Ð±ÐµÐ· Ð²Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹",
        "ÐµÑÑ‚ÑŒ Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ñ‹Ðµ", "ÐºÐ¾Ð½ÑÑ‚Ñ€ÑƒÐºÑ‚Ð¾Ñ€", "tilda", "Ñ‚Ð¸Ð»ÑŒÐ´Ð°", "wix"
    ],
    "diy": [
        "ÑÐ°Ð¼ ÑÐ´ÐµÐ»Ð°ÑŽ", "ÑÐ°Ð¼Ð¸ ÑÐ´ÐµÐ»Ð°ÐµÐ¼", "ÑÐ²Ð¾Ð¸Ð¼Ð¸ ÑÐ¸Ð»Ð°Ð¼Ð¸", "in-house",
        "Ñƒ Ð½Ð°Ñ ÐµÑÑ‚ÑŒ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº", "Ð½Ð°Ñˆ Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð¸ÑÑ‚", "ÑÐ°Ð¼Ð¸ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÐ¼",
        "Ð½Ð°Ð¹Ð¼Ñƒ Ñ„Ñ€Ð¸Ð»Ð°Ð½ÑÐµÑ€Ð°", "ÑÐ°Ð¼ Ð½Ð°Ð¿Ð¸ÑˆÑƒ", "no-code", "Ð½Ð¾Ñƒ-ÐºÐ¾Ð´"
    ],
    "timing": [
        "Ð½Ðµ ÑÐµÐ·Ð¾Ð½", "ÐºÑ€Ð¸Ð·Ð¸Ñ", "ÑÐµÐ¹Ñ‡Ð°Ñ Ð½Ðµ Ð²Ñ€ÐµÐ¼Ñ", "Ð¿Ð¾ÑÐ»Ðµ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð³Ð¾Ð´Ð°",
        "Ð¿Ð¾ÑÐ»Ðµ Ð»ÐµÑ‚Ð°", "ÐºÐ¾Ð³Ð´Ð° Ð±ÑƒÐ´ÑƒÑ‚ Ð´ÐµÐ½ÑŒÐ³Ð¸", "ÐºÐ¾Ð³Ð´Ð° Ñ€Ð°ÑÐºÑ€ÑƒÑ‚Ð¸Ð¼ÑÑ",
        "Ð±Ð¸Ð·Ð½ÐµÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ", "ÐµÑ‰Ñ‘ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»Ð¸ÑÑŒ"
    ]
}

OBJECTION_STRATEGIES = {
    "price": "Ð¡Ð¢Ð ÐÐ¢Ð•Ð“Ð˜Ð¯_Ð¦Ð•ÐÐ: ÐÐ• ÑÐ½Ð¸Ð¶Ð°Ð¹ Ñ†ÐµÐ½Ñƒ! Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ñ‚Ñ€Ñ‘Ñ… Ð¼Ð¾Ð·Ð³Ð¾Ð²:\nâ€¢ Ð ÐµÐ¿Ñ‚Ð¸Ð»ÑŒÐ½Ñ‹Ð¹: \"Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€, Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚Ð° Ð¿Ñ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹, 14 Ð´Ð½ÐµÐ¹ Ð¿Ñ€Ð°Ð²Ð¾Ðº â€” Ð²Ñ‹ Ð½Ð¸Ñ‡ÐµÐ¼ Ð½Ðµ Ñ€Ð¸ÑÐºÑƒÐµÑ‚Ðµ\"\nâ€¢ Ð­Ð¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹: Ð’Ð¸Ð·ÑƒÐ°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ (\"ÐŸÑ€ÐµÐ´ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ: ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñ‹ Ð·Ð°ÐºÐ°Ð·Ñ‹Ð²Ð°ÑŽÑ‚ Ð² 2 ÐºÐ»Ð¸ÐºÐ°, 24/7\")\nâ€¢ Ð Ð°Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹: ÐŸÐ¾ÐºÐ°Ð¶Ð¸ ROI (\"ÐžÐ´Ð¸Ð½ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð·Ð°ÐºÐ°Ð· Ð² Ð´ÐµÐ½ÑŒ Ð¿Ð¾ 2000â‚½ = 60 000â‚½/Ð¼ÐµÑ. ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¾ÐºÑƒÐ¿Ð°ÐµÑ‚ÑÑ Ð·Ð° 2-3 Ð¼ÐµÑÑÑ†Ð°\")\nÐ¯ÐºÐ¾Ñ€ÑŒ: Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð½Ð°Ð·Ð¾Ð²Ð¸ Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ Ð¿Ð°ÐºÐµÑ‚, Ð¿Ð¾Ñ‚Ð¾Ð¼ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ MVP. Ð£Ð¿Ð¾Ð¼ÑÐ½Ð¸ Ñ€Ð°ÑÑÑ€Ð¾Ñ‡ÐºÑƒ Ð¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ ÑÐºÐ¸Ð´Ð¾Ðº Ð·Ð° Ð¼Ð¾Ð½ÐµÑ‚Ñ‹.",
    "delay": "Ð¡Ð¢Ð ÐÐ¢Ð•Ð“Ð˜Ð¯_ÐžÐ¢Ð›ÐžÐ–Ð˜Ð¢Ð¬: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð½ÐµÐ¹Ñ€Ð¾-Ð¿Ð¾Ð´Ñ…Ð¾Ð´ Ðº ÑÑ€Ð¾Ñ‡Ð½Ð¾ÑÑ‚Ð¸:\nâ€¢ Ð ÐµÐ¿Ñ‚Ð¸Ð»ÑŒÐ½Ñ‹Ð¹: ÐœÑÐ³ÐºÐ°Ñ Ð¿Ð¾Ñ‚ÐµÑ€Ñ (\"ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð±ÐµÐ· Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ â€” ÑÑ‚Ð¾ X Ð¿Ð¾Ñ‚ÐµÑ€ÑÐ½Ð½Ñ‹Ñ… ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð²\")\nâ€¢ Ð­Ð¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹: ÐšÐ¾Ð½Ñ‚Ñ€Ð°ÑÑ‚ Ð±ÑƒÐ´ÑƒÑ‰ÐµÐ³Ð¾ (\"Ð§ÐµÑ€ÐµÐ· 10 Ð´Ð½ÐµÐ¹ Ñƒ Ð²Ð°Ñ ÑƒÐ¶Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‰ÐµÐµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ\")\nâ€¢ Ð Ð°Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹: Ð¤Ð°ÐºÑ‚ (\"ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° ÑÐµÐ¹Ñ‡Ð°Ñ ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð°, Ñ‡ÐµÑ€ÐµÐ· 2 Ð½ÐµÐ´ÐµÐ»Ð¸ â€” Ð¾Ñ‡ÐµÑ€ÐµÐ´ÑŒ Ð´Ð¾ Ð¼ÐµÑÑÑ†Ð°\")\nÐœÐ¸ÐºÑ€Ð¾-Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÑÑ‚Ð²Ð¾: ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ñ‹Ð¹ ÑˆÐ°Ð³ â€” Ñ€Ð°ÑÑ‡Ñ‘Ñ‚ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¸Ð»Ð¸ Ð¢Ð—.",
    "competitor": "Ð¡Ð¢Ð ÐÐ¢Ð•Ð“Ð˜Ð¯_ÐšÐžÐÐšÐ£Ð Ð•ÐÐ¢: ÐÐµ ÐºÑ€Ð¸Ñ‚Ð¸ÐºÑƒÐ¹! Ð—Ð°Ð´Ð°Ð²Ð°Ð¹ ÑƒÑ‚Ð¾Ñ‡Ð½ÑÑŽÑ‰Ð¸Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ (\"Ð§Ñ‚Ð¾ Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°ÑŽÑ‚?\"). ÐŸÐ¾Ð´Ñ‡ÐµÑ€ÐºÐ½Ð¸ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ:\nâ€¢ Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð° Telegram Mini Apps (Ð½Ðµ Ð½Ð° Ð²ÑÑ‘Ð¼ Ð¿Ð¾Ð´Ñ€ÑÐ´)\nâ€¢ 7-15 Ð´Ð½ÐµÐ¹ (Ð½Ðµ Ð¼ÐµÑÑÑ†Ñ‹)\nâ€¢ Apple-Ð´Ð¸Ð·Ð°Ð¹Ð½, Ð½ÐµÑ‚ ÐºÐ¾Ð¼Ð¸ÑÑÐ¸Ð¹ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ¾Ð² (ÑÐºÐ¾Ð½Ð¾Ð¼Ð¸Ñ 15-25%)\nâ€¢ Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€ + Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ + ÑÑ‚Ð°Ð¿Ð½Ð°Ñ Ð¾Ð¿Ð»Ð°Ñ‚Ð°\nÐ¡Ð¾Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð´Ð¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»ÑŒÑÑ‚Ð²Ð¾: ÐÐ°Ð·Ð¾Ð²Ð¸ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ ÐºÐµÐ¹ÑÑ‹ (Radiance, TimeElite, GlowSpa).",
    "doubt": "Ð¡Ð¢Ð ÐÐ¢Ð•Ð“Ð˜Ð¯_Ð¡ÐžÐœÐÐ•ÐÐ˜Ð•: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð²Ð¸Ð·ÑƒÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ + ÑÐ¾Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð´Ð¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»ÑŒÑÑ‚Ð²Ð¾:\nâ€¢ \"ÐžÐ´Ð¸Ð½ Ð½Ð°Ñˆ ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð¸Ð· [Ð¿Ð¾Ñ…Ð¾Ð¶Ð°Ñ Ð½Ð¸ÑˆÐ°] Ñ‚Ð¾Ð¶Ðµ ÑÐ¾Ð¼Ð½ÐµÐ²Ð°Ð»ÑÑ. Ð§ÐµÑ€ÐµÐ· Ð¼ÐµÑÑÑ† ÐµÐ³Ð¾ Ð²Ñ‹Ñ€ÑƒÑ‡ÐºÐ° Ð²Ñ‹Ñ€Ð¾ÑÐ»Ð° Ð½Ð° 40%\"\nâ€¢ ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½ÑƒÑŽ ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸ÑŽ (schedule_consultation)\nâ€¢ Ð£Ð¿Ð¾Ð¼ÑÐ½Ð¸ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸ÑŽ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚Ð° Ð¿Ñ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹\nâ€¢ ÐŸÐ¾ÐºÐ°Ð¶Ð¸ Ð¿Ð¾Ñ€Ñ‚Ñ„Ð¾Ð»Ð¸Ð¾ (show_portfolio)\nÐœÐ¸ÐºÑ€Ð¾-Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÑÑ‚Ð²Ð¾: \"Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿Ð¾ÑÑ‡Ð¸Ñ‚Ð°ÐµÐ¼ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ â€” Ð½Ð¸ Ðº Ñ‡ÐµÐ¼Ñƒ Ð½Ðµ Ð¾Ð±ÑÐ·Ñ‹Ð²Ð°ÐµÑ‚\"",
    "trust": "Ð¡Ð¢Ð ÐÐ¢Ð•Ð“Ð˜Ð¯_Ð”ÐžÐ’Ð•Ð Ð˜Ð•: ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¾ÑÑ‚ÑŒ:\nâ€¢ ÐŸÐ¾ÐºÐ°Ð¶Ð¸ Ð¿Ð¾Ñ€Ñ‚Ñ„Ð¾Ð»Ð¸Ð¾ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð¾Ð² (show_portfolio)\nâ€¢ Ð£Ð¿Ð¾Ð¼ÑÐ½Ð¸ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€ (/contract)\nâ€¢ Ð­Ñ‚Ð°Ð¿Ð½Ð°Ñ Ð¾Ð¿Ð»Ð°Ñ‚Ð° (35%+65%) â€” \"ÐŸÐ»Ð°Ñ‚Ð¸Ñ‚Ðµ Ð±Ð¾Ð»ÑŒÑˆÑƒÑŽ Ñ‡Ð°ÑÑ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐºÐ¾Ð³Ð´Ð° ÑƒÐ²Ð¸Ð´Ð¸Ñ‚Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚\"\nâ€¢ 14 Ð´Ð½ÐµÐ¹ Ð¿Ñ€Ð°Ð²Ð¾Ðº Ð¿Ð¾ÑÐ»Ðµ ÑÐ´Ð°Ñ‡Ð¸\nâ€¢ ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð´ÐµÐ¼Ð¾-Ð²ÐµÑ€ÑÐ¸Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð¾Ð²",
    "free": "Ð¡Ð¢Ð ÐÐ¢Ð•Ð“Ð˜Ð¯_Ð‘Ð•Ð¡ÐŸÐ›ÐÐ¢ÐÐžÐ•: ÐÐµ Ð¾Ð±ÐµÑÑ†ÐµÐ½Ð¸Ð²Ð°Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ! ÐŸÐ¾ÐºÐ°Ð¶Ð¸ Ñ€Ð°Ð·Ð½Ð¸Ñ†Ñƒ:\nâ€¢ \"ÐšÐ¾Ð½ÑÑ‚Ñ€ÑƒÐºÑ‚Ð¾Ñ€Ñ‹ (Tilda, Wix) Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ Telegram â€” ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñƒ Ð½ÑƒÐ¶Ð½Ð¾ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ñ‚ÑŒ Ð½Ð° ÑÐ°Ð¹Ñ‚, ÑÑ‚Ð¾ Ñ‚ÐµÑ€ÑÐµÑ‚ 70% ÐºÐ¾Ð½Ð²ÐµÑ€ÑÐ¸Ð¸\"\nâ€¢ \"Ð‘ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾Ðµ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ = Ð²Ð°ÑˆÐµ Ð²Ñ€ÐµÐ¼Ñ + Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð½Ñ‹Ð¹ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð» + Ð±ÐµÐ· Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸\"\nâ€¢ \"Mini App Ð² Telegram â€” ÑÑ‚Ð¾ Ð½Ðµ ÑÐ°Ð¹Ñ‚, ÑÑ‚Ð¾ Ð½Ð°Ñ‚Ð¸Ð²Ð½Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ Ð¼ÐµÑÑÐµÐ½Ð´Ð¶ÐµÑ€Ð°\"\nÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ MVP ÐºÐ°Ðº Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ð¹ Ð²Ñ…Ð¾Ð´: ÑˆÐ°Ð±Ð»Ð¾Ð½ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð° Ð¾Ñ‚ 150Ðº Ñ Ñ€Ð°ÑÑÑ€Ð¾Ñ‡ÐºÐ¾Ð¹ (Ð¿Ñ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚Ð° 52 500â‚½).",
    "diy": "Ð¡Ð¢Ð ÐÐ¢Ð•Ð“Ð˜Ð¯_Ð¡ÐÐœÐ˜: Ð£Ð²Ð°Ð¶Ð°Ð¹ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ, Ð½Ð¾ Ð¿Ð¾ÐºÐ°Ð¶Ð¸ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ:\nâ€¢ \"Ð Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Mini App ÑÐ¸Ð»Ð°Ð¼Ð¸ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ° â€” 2-4 Ð¼ÐµÑÑÑ†Ð°. Ð£ Ð½Ð°Ñ â€” 7-15 Ð´Ð½ÐµÐ¹\"\nâ€¢ \"No-code Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹ Ð½Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÑŽÑ‚ Telegram Mini Apps API Ð½Ð°Ñ‚Ð¸Ð²Ð½Ð¾\"\nâ€¢ \"Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ ÑˆÑ‚Ð°Ñ‚Ð½Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ°: 150-250Ðº/Ð¼ÐµÑ. ÐÐ°Ñˆ Ð¿Ñ€Ð¾ÐµÐºÑ‚ â€” Ñ€Ð°Ð·Ð¾Ð²Ð°Ñ Ð¸Ð½Ð²ÐµÑÑ‚Ð¸Ñ†Ð¸Ñ\"\nValue-first: ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾ ÑÐ¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð¢Ð— â€” \"ÐŸÑ€Ð¸Ð³Ð¾Ð´Ð¸Ñ‚ÑÑ Ð² Ð»ÑŽÐ±Ð¾Ð¼ ÑÐ»ÑƒÑ‡Ð°Ðµ\"",
    "timing": "Ð¡Ð¢Ð ÐÐ¢Ð•Ð“Ð˜Ð¯_Ð’Ð Ð•ÐœÐ¯: ÐŸÐ¾ÐºÐ°Ð¶Ð¸ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ:\nâ€¢ \"ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð¼ÐµÑÑÑ† Ð±ÐµÐ· Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ â€” ÑÑ‚Ð¾ X ÑƒÐ¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ñ… ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð², ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¿Ð¾ÐºÑƒÐ¿Ð°ÑŽÑ‚ Ñƒ ÐºÐ¾Ð½ÐºÑƒÑ€ÐµÐ½Ñ‚Ð¾Ð²\"\nâ€¢ \"Ð›ÑƒÑ‡ÑˆÐµÐµ Ð²Ñ€ÐµÐ¼Ñ â€” ÐºÐ¾Ð³Ð´Ð° Ð±Ð¸Ð·Ð½ÐµÑ Ñ€Ð°ÑÑ‚Ñ‘Ñ‚, Ð° Ð½Ðµ ÐºÐ¾Ð³Ð´Ð° ÑƒÐ¶Ðµ Ð¾Ñ‚ÑÑ‚Ð°Ð»Ð¸\"\nâ€¢ \"Ð Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° 7-15 Ð´Ð½ÐµÐ¹ â€” Ðº [Ð´Ð°Ñ‚Ð° Ñ‡ÐµÑ€ÐµÐ· 2 Ð½ÐµÐ´ÐµÐ»Ð¸] Ñƒ Ð²Ð°Ñ ÑƒÐ¶Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‰ÐµÐµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ\"\nÐœÐ¸ÐºÑ€Ð¾-Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÑÑ‚Ð²Ð¾: \"Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ ÑÐµÐ¹Ñ‡Ð°Ñ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¾Ð±ÑÑƒÐ´Ð¸Ð¼ Ð¸Ð´ÐµÑŽ â€” Ð½Ð¸ Ðº Ñ‡ÐµÐ¼Ñƒ Ð½Ðµ Ð¾Ð±ÑÐ·Ñ‹Ð²Ð°ÐµÑ‚\""
}


EMOTION_PATTERNS = {
    "frustrated": [
        "Ð½Ð°Ð´Ð¾ÐµÐ»Ð¾", "ÑƒÑÑ‚Ð°Ð»", "Ð±ÐµÑÐ¸Ñ‚", "Ñ€Ð°Ð·Ð´Ñ€Ð°Ð¶Ð°ÐµÑ‚", "ÑƒÐ¶Ð°Ñ", "ÐºÐ¾ÑˆÐ¼Ð°Ñ€",
        "Ð¿Ð»Ð¾Ñ…Ð¾", "Ð¾Ñ‚Ð²Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾", "Ð½ÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾", "frustrated", "annoyed",
        "disappointed", "terrible", "worst", "Ñ€Ð°Ð·Ð¾Ñ‡Ð°Ñ€Ð¾Ð²Ð°Ð½", "Ð¾Ñ‚ÑÑ‚Ð¾Ð¹",
        "Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚", "Ð¾Ð¿ÑÑ‚ÑŒ", "ÑÐ½Ð¾Ð²Ð°", "ÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¼Ð¾Ð¶Ð½Ð¾"
    ],
    "excited": [
        "ÐºÑ€ÑƒÑ‚Ð¾", "Ð¾Ñ„Ð¸Ð³ÐµÐ½Ð½Ð¾", "Ð²Ð°Ñƒ", "Ð¿Ð¾Ñ‚Ñ€ÑÑÐ°ÑŽÑ‰Ðµ", "ÑÑƒÐ¿ÐµÑ€", "ÐºÐ»Ð°ÑÑ",
        "Ð²ÐµÐ»Ð¸ÐºÐ¾Ð»ÐµÐ¿Ð½Ð¾", "ÑˆÐ¸ÐºÐ°Ñ€Ð½Ð¾", "amazing", "awesome", "wow", "cool",
        "fantastic", "love it", "Ð¾Ð±Ð°Ð»Ð´ÐµÑ‚ÑŒ", "Ð²Ð¾ÑÑ‚Ð¾Ñ€Ð³",
        "Ñ‚Ð¾Ð¿", "Ð±Ð¾Ð¼Ð±Ð°", "Ð¾Ð³Ð¾Ð½ÑŒ", "Ð¾Ñ‚Ð»Ð¸Ñ‡Ð½Ð¾"
    ],
    "confused": [
        "Ð½Ðµ Ð¿Ð¾Ð½Ð¸Ð¼Ð°ÑŽ", "Ð·Ð°Ð¿ÑƒÑ‚Ð°Ð»ÑÑ", "ÑÐ»Ð¾Ð¶Ð½Ð¾", "Ð½ÐµÐ¿Ð¾Ð½ÑÑ‚Ð½Ð¾", "Ð¾Ð±ÑŠÑÑÐ½Ð¸Ñ‚Ðµ",
        "ÐºÐ°Ðº ÑÑ‚Ð¾", "Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾ Ð·Ð½Ð°Ñ‡Ð¸Ñ‚", "Ð½Ðµ ÑÑÐ½Ð¾", "confused", "don't understand",
        "what do you mean", "unclear", "Ð° Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ñ€Ð¾Ñ‰Ðµ", "Ð½Ðµ Ñ€Ð°Ð·Ð±Ð¸Ñ€Ð°ÑŽÑÑŒ",
        "Ñ…Ð·", "Ð½Ðµ Ð·Ð½Ð°ÑŽ"
    ],
    "urgent": [
        "ÑÑ€Ð¾Ñ‡Ð½Ð¾", "Ð±Ñ‹ÑÑ‚Ñ€ÐµÐµ", "ÑÐºÐ¾Ñ€ÐµÐµ", "ÑÐµÐ¹Ñ‡Ð°Ñ", "Ð½ÐµÐ¼ÐµÐ´Ð»ÐµÐ½Ð½Ð¾",
        "urgent", "asap", "hurry", "deadline", "Ð³Ð¾Ñ€Ð¸Ñ‚", "Ð²Ñ‡ÐµÑ€Ð° Ð½ÑƒÐ¶Ð½Ð¾ Ð±Ñ‹Ð»Ð¾",
        "Ð·Ð°Ð²Ñ‚Ñ€Ð° Ð·Ð°Ð¿ÑƒÑÐº", "Ð²Ñ€ÐµÐ¼Ñ Ð¿Ð¾Ð´Ð¶Ð¸Ð¼Ð°ÐµÑ‚"
    ],
    "skeptical": [
        "Ð²ÐµÑ€Ð¸Ñ‚ÑÑ Ñ Ñ‚Ñ€ÑƒÐ´Ð¾Ð¼", "ÑÐ¾Ð¼Ð½ÐµÐ²Ð°ÑŽÑÑŒ", "Ð·Ð²ÑƒÑ‡Ð¸Ñ‚ ÐºÐ°Ðº", "Ð½Ñƒ-Ð½Ñƒ",
        "Ð´Ð° Ð»Ð°Ð´Ð½Ð¾", "ÑÐµÑ€ÑŒÑ‘Ð·Ð½Ð¾?", "Ð²Ñ€ÑÐ´ Ð»Ð¸", "skeptical", "really?",
        "Ð¼Ð°Ð»Ð¾Ð²ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾", "Ð°Ð³Ð° ÐºÐ¾Ð½ÐµÑ‡Ð½Ð¾", "ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ñ…Ð¾Ñ€Ð¾ÑˆÐ¾"
    ]
}

EMOTION_HINTS = {
    "frustrated": "Ð¢ÐžÐ: ÐšÐ»Ð¸ÐµÐ½Ñ‚ Ñ€Ð°Ð·Ð´Ñ€Ð°Ð¶Ñ‘Ð½. ÐœÐ¾Ð´ÐµÐ»ÑŒ Ñ‚Ñ€Ñ‘Ñ… Ð¼Ð¾Ð·Ð³Ð¾Ð²: Ð¾Ð±Ñ€Ð°Ñ‚Ð¸ÑÑŒ Ðº Ñ€ÐµÐ¿Ñ‚Ð¸Ð»ÑŒÐ½Ð¾Ð¼Ñƒ (ÑƒÐ±ÐµÑ€Ð¸ ÑƒÐ³Ñ€Ð¾Ð·Ñƒ â€” \"ÐŸÐ¾Ð½Ð¸Ð¼Ð°ÑŽ, ÑÑ‚Ð¾ Ð½ÐµÐ¿Ñ€Ð¸ÑÑ‚Ð½Ð¾\"), Ð¿Ð¾Ñ‚Ð¾Ð¼ Ðº ÑÐ¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾Ð¼Ñƒ (ÑÐ¼Ð¿Ð°Ñ‚Ð¸Ñ â€” \"Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ñ Ð¿Ð¾Ð¼Ð¾Ð³Ñƒ Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ ÑÑ‚Ð¾\"), Ð¿Ð¾Ñ‚Ð¾Ð¼ Ðº Ñ€Ð°Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾Ð¼Ñƒ (ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ð¿Ð»Ð°Ð½). ÐÐ• Ð¾Ð¿Ñ€Ð°Ð²Ð´Ñ‹Ð²Ð°Ð¹ÑÑ.",
    "excited": "Ð¢ÐžÐ: ÐšÐ»Ð¸ÐµÐ½Ñ‚ Ð²Ð¾Ð¾Ð´ÑƒÑˆÐµÐ²Ð»Ñ‘Ð½! Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚: Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸ ÑÐ½ÐµÑ€Ð³Ð¸ÑŽ Ð¸ ÑÑ€Ð°Ð·Ñƒ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð¼Ð¸ÐºÑ€Ð¾-Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÑÑ‚Ð²Ð¾ â€” ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ ÑˆÐ°Ð³ (\"Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ð¿Ñ€ÑÐ¼Ð¾ ÑÐµÐ¹Ñ‡Ð°Ñ Ð¿Ð¾ÑÑ‡Ð¸Ñ‚Ð°ÐµÐ¼ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ?\"). Foot-in-the-door: Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ¾Ðµ \"Ð´Ð°\" Ð²ÐµÐ´Ñ‘Ñ‚ Ðº Ð±Ð¾Ð»ÑŒÑˆÐ¾Ð¼Ñƒ.",
    "confused": "Ð¢ÐžÐ: ÐšÐ»Ð¸ÐµÐ½Ñ‚ Ð·Ð°Ð¿ÑƒÑ‚Ð°Ð½. Ð£Ð¿Ñ€Ð¾ÑÑ‚Ð¸ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸Ð¸ Ð¸Ð· Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ð¶Ð¸Ð·Ð½Ð¸ (\"Ð­Ñ‚Ð¾ ÐºÐ°Ðº Ð²Ð¸Ñ‚Ñ€Ð¸Ð½Ð° Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð°, Ð½Ð¾ Ð¿Ñ€ÑÐ¼Ð¾ Ð² Telegram\"). ÐžÐ´Ð¸Ð½ Ñ‚ÐµÐ·Ð¸Ñ Ð·Ð° Ñ€Ð°Ð·. Ð¡Ð¿Ñ€Ð¾ÑÐ¸ Ñ‡Ñ‚Ð¾ Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ¿Ð¾Ð½ÑÑ‚Ð½Ð¾.",
    "urgent": "Ð¢ÐžÐ: Ð£ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° ÑÑ€Ð¾Ñ‡Ð½Ð¾ÑÑ‚ÑŒ. Ð”ÐµÐ¹ÑÑ‚Ð²ÑƒÐ¹ Ð±Ñ‹ÑÑ‚Ñ€Ð¾: ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ ÑÑ€Ð¾ÐºÐ¸ (\"Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ð¼ Ð·Ð° 7-10 Ð´Ð½ÐµÐ¹\"), ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ ÑˆÐ°Ð³Ð¸ (\"ÐžÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð·Ð°ÑÐ²ÐºÑƒ ÑÐµÐ¹Ñ‡Ð°Ñ â€” Ð½Ð°Ñ‡Ð½Ñ‘Ð¼ Ð·Ð°Ð²Ñ‚Ñ€Ð°\"). Ð‘ÐµÐ· Ð»Ð¸ÑˆÐ½Ð¸Ñ… Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð².",
    "skeptical": "Ð¢ÐžÐ: ÐšÐ»Ð¸ÐµÐ½Ñ‚ ÑÐºÐµÐ¿Ñ‚Ð¸Ñ‡ÐµÐ½. Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ñ„Ð°ÐºÑ‚Ñ‹ Ð¸ Ð´Ð¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»ÑŒÑÑ‚Ð²Ð°. Ð¡Ð¾Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð´Ð¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»ÑŒÑÑ‚Ð²Ð¾: ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ ÐºÐµÐ¹ÑÑ‹ Ñ Ñ†Ð¸Ñ„Ñ€Ð°Ð¼Ð¸. Ð§ÐµÑÑ‚Ð½Ð¾ÑÑ‚ÑŒ: \"ÐÐµ Ð±ÑƒÐ´Ñƒ Ð¾Ð±ÐµÑ‰Ð°Ñ‚ÑŒ Ñ‡ÑƒÐ´ÐµÑ, Ð½Ð¾ Ð²Ð¾Ñ‚ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð½Ð°ÑˆÐ¸Ñ… ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð²...\""
}


SOCIAL_PROOF_TRIGGERS = {
    "doubt": [
        "ÐžÐ´Ð¸Ð½ Ð½Ð°Ñˆ ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð¸Ð· ÑÑ„ÐµÑ€Ñ‹ ÑƒÑÐ»ÑƒÐ³ Ð·Ð° Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð¼ÐµÑÑÑ† Ð¿Ð¾ÑÐ»Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð» 47 Ð½Ð¾Ð²Ñ‹Ñ… Ð·Ð°ÐºÐ°Ð·Ð¾Ð² Ñ‡ÐµÑ€ÐµÐ· Mini App â€” Ð¿Ñ€Ð¸ ÑÑ€ÐµÐ´Ð½ÐµÐ¼ Ñ‡ÐµÐºÐµ 3 500â‚½ ÑÑ‚Ð¾ +164 000â‚½ Ð²Ñ‹Ñ€ÑƒÑ‡ÐºÐ¸.",
        "Radiance (Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½ Ð¾Ð´ÐµÐ¶Ð´Ñ‹) â€” Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»Ð¸ Ð·Ð° 10 Ð´Ð½ÐµÐ¹, Ð² Ð¿ÐµÑ€Ð²ÑƒÑŽ Ð½ÐµÐ´ÐµÐ»ÑŽ 200+ Ð·Ð°ÐºÐ°Ð·Ð¾Ð². Ð’Ð»Ð°Ð´ÐµÐ»ÐµÑ† ÑÐºÐ°Ð·Ð°Ð»: \"Ð–Ð°Ð»ÐµÑŽ, Ñ‡Ñ‚Ð¾ Ð½Ðµ ÑÐ´ÐµÐ»Ð°Ð» Ñ€Ð°Ð½ÑŒÑˆÐµ\".",
        "Ð£ 87% Ð½Ð°ÑˆÐ¸Ñ… ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð² Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¾ÐºÑƒÐ¿Ð°ÐµÑ‚ÑÑ Ð² Ð¿ÐµÑ€Ð²Ñ‹Ðµ 2-3 Ð¼ÐµÑÑÑ†Ð° â€” Ð¼Ñ‹ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ð¾ ÑÑ‡Ð¸Ñ‚Ð°ÐµÐ¼ ROI Ð¿ÐµÑ€ÐµÐ´ ÑÑ‚Ð°Ñ€Ñ‚Ð¾Ð¼."
    ],
    "competitor": [
        "ÐÐ°ÑˆÐµ Ð¾Ñ‚Ð»Ð¸Ñ‡Ð¸Ðµ: Ð¼Ñ‹ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð° Telegram Mini Apps. ÐÐµ Ð´ÐµÐ»Ð°ÐµÐ¼ ÑÐ°Ð¹Ñ‚Ñ‹, Ð½Ðµ Ð´ÐµÐ»Ð°ÐµÐ¼ Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ â€” Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Telegram. ÐŸÐ¾ÑÑ‚Ð¾Ð¼Ñƒ Ð´ÐµÐ»Ð°ÐµÐ¼ Ð·Ð° 7-15 Ð´Ð½ÐµÐ¹ Ñ‚Ð¾, Ñ‡Ñ‚Ð¾ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð´ÐµÐ»Ð°ÑŽÑ‚ Ð·Ð° 2-3 Ð¼ÐµÑÑÑ†Ð°.",
        "Ð’ Ð¾Ñ‚Ð»Ð¸Ñ‡Ð¸Ðµ Ð¾Ñ‚ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ¾Ð² (WB, Ozon), Ð² Telegram Mini App Ð½ÐµÑ‚ ÐºÐ¾Ð¼Ð¸ÑÑÐ¸Ð¹ 15-25%. Ð’ÑÑ Ð²Ñ‹Ñ€ÑƒÑ‡ÐºÐ° â€” Ð²Ð°ÑˆÐ°.",
        "Ð¤Ñ€Ð¸Ð»Ð°Ð½ÑÐµÑ€ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸Ñ‚ Ð´ÐµÑˆÐµÐ²Ð»Ðµ, Ð½Ð¾: Ð½ÐµÑ‚ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð°, Ð½ÐµÑ‚ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¸, Ð½ÐµÑ‚ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸, ÑÑ€Ð¾ÐºÐ¸ Ð¿Ð»Ñ‹Ð²ÑƒÑ‚. Ð£ Ð½Ð°Ñ â€” Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€, 35%+65% Ð¾Ð¿Ð»Ð°Ñ‚Ð°, 14 Ð´Ð½ÐµÐ¹ Ð¿Ñ€Ð°Ð²Ð¾Ðº."
    ],
    "trust": [
        "Ð£ Ð½Ð°Ñ Ð±Ð¾Ð»ÐµÐµ 20 Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½Ð½Ñ‹Ñ… Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð¾Ð²: Radiance, TimeElite, GlowSpa, DeluxeDine. Ð’ÑÐµ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð² Ð¿Ð¾Ñ€Ñ‚Ñ„Ð¾Ð»Ð¸Ð¾.",
        "Ð Ð°Ð±Ð¾Ñ‚Ð°ÐµÐ¼ Ð¿Ð¾ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ñƒ. ÐŸÑ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚Ð° 35% â€” Ð´Ð¸Ð·Ð°Ð¹Ð½ Ð¸ Ð¿Ñ€Ð¾Ñ‚Ð¾Ñ‚Ð¸Ð¿. ÐžÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ 65% â€” Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐºÐ¾Ð³Ð´Ð° Ð²Ñ‹ Ð¾Ð´Ð¾Ð±Ñ€Ð¸Ñ‚Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚.",
        "14 Ð´Ð½ÐµÐ¹ Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ñ‹Ñ… Ð¿Ñ€Ð°Ð²Ð¾Ðº Ð¿Ð¾ÑÐ»Ðµ ÑÐ´Ð°Ñ‡Ð¸. Ð•ÑÐ»Ð¸ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð½Ðµ ÑƒÑÑ‚Ñ€Ð¾Ð¸Ñ‚ â€” Ð²ÐµÑ€Ð½Ñ‘Ð¼ Ð¿Ñ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚Ñƒ."
    ],
    "price": [
        "Ð”Ð»Ñ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ: ÑˆÑ‚Ð°Ñ‚Ð½Ñ‹Ð¹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÑÑ‚Ð¾Ð¸Ñ‚ 150-250Ðº/Ð¼ÐµÑ Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ 2-4 Ð¼ÐµÑÑÑ†Ð°. ÐÐ°Ñˆ Ð¿Ñ€Ð¾ÐµÐºÑ‚ â€” Ñ€Ð°Ð·Ð¾Ð²Ð°Ñ Ð¸Ð½Ð²ÐµÑÑ‚Ð¸Ñ†Ð¸Ñ Ð¾Ñ‚ 150Ðº Ð¸ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ñ‡ÐµÑ€ÐµÐ· 7-15 Ð´Ð½ÐµÐ¹.",
        "Ð¡Ñ€ÐµÐ´Ð½Ð¸Ð¹ ROI Ð½Ð°ÑˆÐ¸Ñ… ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð² â€” 300% Ð·Ð° Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð³Ð¾Ð´. ÐŸÑ€Ð¸ ÑÑ€ÐµÐ´Ð½ÐµÐ¼ Ñ‡ÐµÐºÐµ 2000â‚½ Ð¸ 3 Ð´Ð¾Ð¿. Ð·Ð°ÐºÐ°Ð·Ð°Ñ… Ð² Ð´ÐµÐ½ÑŒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð·Ð° 150Ðº Ð¾ÐºÑƒÐ¿Ð°ÐµÑ‚ÑÑ Ð·Ð° 25 Ð´Ð½ÐµÐ¹.",
        "Ð Ð°ÑÑÑ€Ð¾Ñ‡ÐºÐ°: Ð¿Ñ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚Ð° Ð²ÑÐµÐ³Ð¾ 52 500â‚½ (35%) Ð·Ð° Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½. ÐžÑÑ‚Ð°Ð»ÑŒÐ½Ð¾Ðµ â€” ÐºÐ¾Ð³Ð´Ð° ÑƒÐ²Ð¸Ð´Ð¸Ñ‚Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚."
    ]
}


FUNNEL_STAGE_SIGNALS = {
    "awareness": {
        "keywords": [
            "Ð¿Ñ€Ð¸Ð²ÐµÑ‚", "Ð·Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ", "Ð´Ð¾Ð±Ñ€Ñ‹Ð¹", "hello", "hi",
            "Ñ‡Ñ‚Ð¾ Ð²Ñ‹ Ð´ÐµÐ»Ð°ÐµÑ‚Ðµ", "Ñ‡ÐµÐ¼ Ð·Ð°Ð½Ð¸Ð¼Ð°ÐµÑ‚ÐµÑÑŒ", "Ñ‡Ñ‚Ð¾ Ñ‚Ð°ÐºÐ¾Ðµ",
            "Ñ€Ð°ÑÑÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¾ ÑÐµÐ±Ðµ", "ÐºÑ‚Ð¾ Ð²Ñ‹"
        ],
        "max_messages": 3,
        "instruction": "Ð¡Ð¢ÐÐ”Ð˜Ð¯: Ð—ÐÐÐšÐžÐœÐ¡Ð¢Ð’Ðž (Awareness)\nÐ—Ð°Ð´Ð°Ñ‡Ð°: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚ Ð¸ Ð¿Ð¾Ð½ÑÑ‚ÑŒ Ð±Ð¸Ð·Ð½ÐµÑ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°.\nSPIN-Ñ„Ð°Ð·Ð°: Situation â€” Ð·Ð°Ð´Ð°Ð²Ð°Ð¹ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¾ Ð±Ð¸Ð·Ð½ÐµÑÐµ.\nÐ¢Ð¾Ð½: Ð¢Ñ‘Ð¿Ð»Ñ‹Ð¹, Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ñ‹Ð¹, Ð»ÑŽÐ±Ð¾Ð¿Ñ‹Ñ‚Ð½Ñ‹Ð¹.\nÐ¦ÐµÐ»ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°: Ð£Ð·Ð½Ð°Ñ‚ÑŒ Ñ‚Ð¸Ð¿ Ð±Ð¸Ð·Ð½ÐµÑÐ° Ð¸ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ ÑÐ¸Ñ‚ÑƒÐ°Ñ†Ð¸ÑŽ.\nÐŸÑ€Ð¸Ð¼ÐµÑ€: \"Ð Ð°ÑÑÐºÐ°Ð¶Ð¸Ñ‚Ðµ, ÐºÐ°ÐºÐ¾Ð¹ Ñƒ Ð²Ð°Ñ Ð±Ð¸Ð·Ð½ÐµÑ? Ð§ÐµÐ¼ Ð·Ð°Ð½Ð¸Ð¼Ð°ÐµÑ‚ÐµÑÑŒ?\"\nÐœÐ¸ÐºÑ€Ð¾-Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÑÑ‚Ð²Ð¾: Ð’Ð¾Ð²Ð»ÐµÑ‡ÑŒ Ð² Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€."
    },
    "interest": {
        "keywords": [
            "Ñ†ÐµÐ½Ð°", "ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ", "ÑÐºÐ¾Ð»ÑŒÐºÐ¾", "Ð¿Ñ€Ð°Ð¹Ñ", "Ñ‚Ð°Ñ€Ð¸Ñ„",
            "ÑÑ€Ð¾ÐºÐ¸", "ÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸", "ÐºÐ¾Ð³Ð´Ð° Ð±ÑƒÐ´ÐµÑ‚ Ð³Ð¾Ñ‚Ð¾Ð²Ð¾",
            "Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸", "Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸", "Ñ‡Ñ‚Ð¾ ÑƒÐ¼ÐµÐµÑ‚", "Ð¼Ð¾Ð¶Ð½Ð¾ Ð»Ð¸",
            "price", "cost", "how much", "features"
        ],
        "max_messages": 8,
        "instruction": "Ð¡Ð¢ÐÐ”Ð˜Ð¯: Ð˜ÐÐ¢Ð•Ð Ð•Ð¡ (Interest)\nÐ—Ð°Ð´Ð°Ñ‡Ð°: Ð”Ð°Ñ‚ÑŒ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð¸ÐºÑƒ Ð¸ Ð²Ñ‹ÑÐ²Ð¸Ñ‚ÑŒ Ð±Ð¾Ð»ÑŒ.\nSPIN-Ñ„Ð°Ð·Ð°: Problem â€” Ð¸Ñ‰Ð¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñƒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° (\"Ð¡ ÐºÐ°ÐºÐ¸Ð¼Ð¸ ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑÐ¼Ð¸ ÑÑ‚Ð°Ð»ÐºÐ¸Ð²Ð°ÐµÑ‚ÐµÑÑŒ Ð² Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð°Ñ…?\").\nÐ¢Ð¾Ð½: Ð­ÐºÑÐ¿ÐµÑ€Ñ‚Ð½Ñ‹Ð¹, Ð½Ð¾ Ð½Ðµ Ð¿ÐµÑ€ÐµÐ³Ñ€ÑƒÐ¶Ð°Ð¹.\nÐ¦ÐµÐ»ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°: ÐŸÐ¾Ð½ÑÑ‚ÑŒ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñƒ Ð¸ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð½Ð¾ÑÑ‚ÑŒ.\nÐ˜Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹: calculate_price, show_portfolio.\nÐœÐ¸ÐºÑ€Ð¾-Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÑÑ‚Ð²Ð¾: \"Ð¥Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¿Ð¾ÑÑ‡Ð¸Ñ‚Ð°ÑŽ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¿Ð¾Ð´ Ð²Ð°ÑˆÐ¸ Ð·Ð°Ð´Ð°Ñ‡Ð¸?\""
    },
    "consideration": {
        "keywords": [
            "ÑÑ€Ð°Ð²Ð½Ð¸Ñ‚ÑŒ", "Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²", "ÐºÐ¾Ð½ÐºÑƒÑ€ÐµÐ½Ñ‚", "Ð´Ñ€ÑƒÐ³Ð¸Ðµ",
            "Ð° ÐµÑÐ»Ð¸", "Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¸", "Ð° Ñ‚Ð¾Ñ‡Ð½Ð¾", "Ð¿Ð¾Ð´ÑƒÐ¼Ð°ÑŽ", "Ð´ÑƒÐ¼Ð°ÑŽ",
            "ÑÐ¾Ð¼Ð½ÐµÐ²Ð°ÑŽÑÑŒ", "Ð½Ðµ ÑƒÐ²ÐµÑ€ÐµÐ½", "Ñ€Ð¸ÑÐº", "compare"
        ],
        "max_messages": 15,
        "instruction": "Ð¡Ð¢ÐÐ”Ð˜Ð¯: Ð ÐÐ¡Ð¡ÐœÐžÐ¢Ð Ð•ÐÐ˜Ð• (Consideration)\nÐ—Ð°Ð´Ð°Ñ‡Ð°: Ð¡Ð½ÑÑ‚ÑŒ ÑÐ¾Ð¼Ð½ÐµÐ½Ð¸Ñ Ð¸ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ†ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ.\nSPIN-Ñ„Ð°Ð·Ð°: Implication â€” ÑƒÑÐ¸Ð»ÑŒ Ð±Ð¾Ð»ÑŒ Ð±ÐµÐ·Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ (\"Ð¡ÐºÐ¾Ð»ÑŒÐºÐ¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð² Ð²Ñ‹ Ñ‚ÐµÑ€ÑÐµÑ‚Ðµ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð±ÐµÐ· Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ?\").\nÐ¢Ð¾Ð½: Ð£Ð²ÐµÑ€ÐµÐ½Ð½Ñ‹Ð¹, Ñ ÑÐ¾Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð´Ð¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»ÑŒÑÑ‚Ð²Ð°Ð¼Ð¸.\nÐ¦ÐµÐ»ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°: ÐŸÐ¾Ð´Ð²ÐµÑÑ‚Ð¸ Ðº Ð¾ÑÐ¾Ð·Ð½Ð°Ð½Ð¸ÑŽ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð±ÐµÐ·Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ.\nÐ˜Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹: calculate_roi, compare_plans, check_discount.\nÐœÐ¸ÐºÑ€Ð¾-Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÑÑ‚Ð²Ð¾: \"Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ð¿Ð¾ÐºÐ°Ð¶Ñƒ, ÐºÐ°Ðº ÑÑ‚Ð¾ Ñ€ÐµÑˆÐ°ÐµÑ‚ÑÑ Ð·Ð° 10 Ð´Ð½ÐµÐ¹?\"\nÐ’Ð¸Ð·ÑƒÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ: \"ÐŸÑ€ÐµÐ´ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ: Ñ‡ÐµÑ€ÐµÐ· 2 Ð½ÐµÐ´ÐµÐ»Ð¸ Ð²Ð°ÑˆÐ¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñ‹ Ð·Ð°ÐºÐ°Ð·Ñ‹Ð²Ð°ÑŽÑ‚ Ð¿Ñ€ÑÐ¼Ð¾ Ð² Telegram.\""
    },
    "decision": {
        "keywords": [
            "Ð·Ð°ÐºÐ°Ð·", "Ð¾Ñ„Ð¾Ñ€Ð¼Ð¸Ñ‚ÑŒ", "Ð´Ð°Ð²Ð°Ð¹Ñ‚Ðµ", "Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÐ¼", "Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€",
            "ÐºÐ¾Ð½Ñ‚Ñ€Ð°ÐºÑ‚", "ÐºÐ¾Ð³Ð´Ð° Ð½Ð°Ñ‡Ð½Ñ‘Ð¼", "Ð³Ð¾Ñ‚Ð¾Ð²", "Ñ…Ð¾Ñ‡Ñƒ Ð·Ð°ÐºÐ°Ð·Ð°Ñ‚ÑŒ",
            "Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ", "ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ñ", "ÑÐ¾Ð·Ð²Ð¾Ð½", "let's start",
            "Ð±Ñ€Ð¸Ñ„", "Ð¢Ð—", "Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð·Ð°Ð´Ð°Ð½Ð¸Ðµ"
        ],
        "max_messages": 999,
        "instruction": "Ð¡Ð¢ÐÐ”Ð˜Ð¯: Ð Ð•Ð¨Ð•ÐÐ˜Ð• (Decision)\nÐ—Ð°Ð´Ð°Ñ‡Ð°: Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ ÑÐ´ÐµÐ»ÐºÑƒ, Ð·Ð°Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ñ‘Ð½Ð½Ð¾ÑÑ‚Ð¸.\nSPIN-Ñ„Ð°Ð·Ð°: Need-Payoff â€” ÐºÐ»Ð¸ÐµÐ½Ñ‚ ÑÐ°Ð¼ Ð²Ð¸Ð´Ð¸Ñ‚ Ñ†ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ (\"ÐšÐ°Ðº Ð¸Ð·Ð¼ÐµÐ½ÑÑ‚ÑÑ Ð²Ð°ÑˆÐ¸ Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð¸ Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÐµÐ¼?\").\nÐ¢Ð¾Ð½: Ð”ÐµÐ»Ð¾Ð²Ð¾Ð¹, ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹, Ð±ÐµÐ· Ð»Ð¸ÑˆÐ½Ð¸Ñ… ÑÐ»Ð¾Ð².\nÐ¦ÐµÐ»ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°: ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÑÑ‚Ð²Ð¾ Ð½Ð° ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ ÑˆÐ°Ð³.\nÐ˜Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹: generate_brief, schedule_consultation, create_lead.\nÐœÐ¸ÐºÑ€Ð¾-Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÑÑ‚Ð²Ð¾: \"ÐšÐ¾Ð³Ð´Ð° ÑƒÐ´Ð¾Ð±Ð½Ð¾ Ð¾Ð±ÑÑƒÐ´Ð¸Ñ‚ÑŒ Ð´ÐµÑ‚Ð°Ð»Ð¸ â€” ÑÐµÐ³Ð¾Ð´Ð½Ñ Ð¸Ð»Ð¸ Ð·Ð°Ð²Ñ‚Ñ€Ð°?\""
    },
    "action": {
        "keywords": [
            "Ð¾Ð¿Ð»Ð°Ñ‚", "Ð¾Ð¿Ð»Ð°Ñ‡Ñƒ", "Ñ€ÐµÐºÐ²Ð¸Ð·Ð¸Ñ‚Ñ‹", "Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´", "ÐºÐ°Ñ€Ñ‚Ð°",
            "ÑÑ‡Ñ‘Ñ‚", "invoice", "pay", "payment", "Ñ€Ð°ÑÑÑ€Ð¾Ñ‡ÐºÐ°"
        ],
        "max_messages": 999,
        "instruction": "Ð¡Ð¢ÐÐ”Ð˜Ð¯: ÐžÐŸÐ›ÐÐ¢Ð (Action)\nÐ—Ð°Ð´Ð°Ñ‡Ð°: Ð£Ð¿Ñ€Ð¾ÑÑ‚Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹.\nÐ¢Ð¾Ð½: ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÑŽÑ‰Ð¸Ð¹, Ñ‡Ñ‘Ñ‚ÐºÐ¸Ð¹.\nÐ˜Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹: show_payment_info.\nÐÐ°Ð¿Ð¾Ð¼Ð½Ð¸: Ñ€Ð°ÑÑÑ€Ð¾Ñ‡ÐºÐ° 35%+65%, Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð´Ð¾ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹.\nÐ£Ð±ÐµÑ€Ð¸ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ ÑÐ¾Ð¼Ð½ÐµÐ½Ð¸Ñ: \"14 Ð´Ð½ÐµÐ¹ Ð¿Ñ€Ð°Ð²Ð¾Ðº Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾, Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚Ð° Ð¿Ñ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹.\""
    }
}


MOMENTUM_PATTERNS = {
    "low_engagement": [
        "Ð¾Ðº", "ok", "ÑƒÐ³Ñƒ", "Ð°Ð³Ð°", "Ð´Ð°", "Ð½ÐµÑ‚", "Ð¿Ð¾Ð½ÑÐ»", "ÑÑÐ½Ð¾",
        "Ñ…Ð¾Ñ€Ð¾ÑˆÐ¾", "Ð»Ð°Ð´Ð½Ð¾", "Ð¼Ð¼", "Ð½Ñƒ", "fine", "sure", "yeah"
    ],
    "topic_drift": [
        "Ð° ÐºÑÑ‚Ð°Ñ‚Ð¸", "Ð²Ð¾Ð¾Ð±Ñ‰Ðµ", "by the way", "ÐºÑÑ‚Ð°Ñ‚Ð¸",
        "Ð½Ðµ ÑÐ²ÑÐ·Ð°Ð½Ð¾", "Ð´Ñ€ÑƒÐ³Ð¾Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ", "Ð° ÐµÑ‰Ñ‘"
    ]
}

MOMENTUM_STRATEGIES = {
    "low_engagement": "MOMENTUM ÐÐ˜Ð—ÐšÐ˜Ð™: ÐšÐ»Ð¸ÐµÐ½Ñ‚ Ð´Ð°Ñ‘Ñ‚ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹ â€” Ñ‚ÐµÑ€ÑÐµÑ‚ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑ. Ð¡Ð¼ÐµÐ½Ð¸ Ñ‚Ð°ÐºÑ‚Ð¸ÐºÑƒ:\nâ€¢ Ð—Ð°Ð´Ð°Ð¹ Ð¿Ñ€Ð¾Ð²Ð¾ÐºÐ°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ (\"Ð Ð²Ñ‹ Ð·Ð½Ð°Ð»Ð¸, Ñ‡Ñ‚Ð¾ 70% ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð² ÑƒÑ…Ð¾Ð´ÑÑ‚ Ðº ÐºÐ¾Ð½ÐºÑƒÑ€ÐµÐ½Ñ‚Ð°Ð¼ Ð¸Ð·-Ð·Ð° Ð½ÐµÑƒÐ´Ð¾Ð±Ð½Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð°?\")\nâ€¢ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐºÐ¾Ð½Ñ‚Ñ€Ð°ÑÑ‚ (\"Ð¡ÐµÐ¹Ñ‡Ð°Ñ vs Ñ‡ÐµÑ€ÐµÐ· 10 Ð´Ð½ÐµÐ¹ Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÐµÐ¼\")\nâ€¢ ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ð²Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ñ€Ð¸Ð¼ÐµÑ€\nâ€¢ Ð˜Ð»Ð¸ Ð¿Ñ€ÑÐ¼Ð¾ ÑÐ¿Ñ€Ð¾ÑÐ¸: \"Ð§Ñ‚Ð¾ Ð´Ð»Ñ Ð²Ð°Ñ ÑÐµÐ¹Ñ‡Ð°Ñ ÑÐ°Ð¼Ð¾Ðµ Ð²Ð°Ð¶Ð½Ð¾Ðµ?\"",
    "topic_drift": "MOMENTUM Ð”Ð Ð•Ð™Ð¤: ÐšÐ»Ð¸ÐµÐ½Ñ‚ ÑƒÑ…Ð¾Ð´Ð¸Ñ‚ Ð¾Ñ‚ Ñ‚ÐµÐ¼Ñ‹. ÐœÑÐ³ÐºÐ¾ Ð²ÐµÑ€Ð½Ð¸:\nâ€¢ ÐžÑ‚Ð²ÐµÑ‚ÑŒ ÐºÑ€Ð°Ñ‚ÐºÐ¾ Ð½Ð° Ð¾Ñ‚Ð²Ð»ÐµÑ‡Ñ‘Ð½Ð½Ñ‹Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ\nâ€¢ Ð¡Ð²ÑÐ¶Ð¸ ÐµÐ³Ð¾ Ñ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ñ‚ÐµÐ¼Ð¾Ð¹\nâ€¢ \"ÐšÑÑ‚Ð°Ñ‚Ð¸, Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÑÑÑŒ Ðº Ð²Ð°ÑˆÐµÐ¼Ñƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñƒ...\""
}


DYNAMIC_BUTTONS_BY_STAGE = {
    "awareness": [
        ("ðŸ’° Ð£Ð·Ð½Ð°Ñ‚ÑŒ Ñ†ÐµÐ½Ñ‹", "smart_prices"),
        ("ðŸ“‚ ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ñ€Ð°Ð±Ð¾Ñ‚", "smart_portfolio"),
        ("â“ Ð§Ð°ÑÑ‚Ñ‹Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹", "smart_faq")
    ],
    "interest": [
        ("ðŸ§® Ð Ð°ÑÑÑ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ", "smart_calc"),
        ("ðŸ“‚ ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ñ‹", "smart_portfolio"),
        ("ðŸ“Š Ð¡Ñ€Ð°Ð²Ð½Ð¸Ñ‚ÑŒ Ð¿Ð°ÐºÐµÑ‚Ñ‹", "smart_compare")
    ],
    "consideration": [
        ("ðŸ“Š Ð Ð°ÑÑÑ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð¾ÐºÑƒÐ¿Ð°ÐµÐ¼Ð¾ÑÑ‚ÑŒ", "smart_roi"),
        ("ðŸŽ Ð£Ð·Ð½Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾ ÑÐºÐ¸Ð´ÐºÐ¸", "smart_discount"),
        ("ðŸ“ž Ð‘ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð°Ñ ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ñ", "smart_consult")
    ],
    "decision": [
        ("ðŸ“‹ Ð¡Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð¢Ð—", "smart_brief"),
        ("ðŸ“ž Ð—Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ Ð½Ð° ÑÐ¾Ð·Ð²Ð¾Ð½", "smart_consult"),
        ("âœ… ÐžÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°ÑÐ²ÐºÑƒ", "smart_lead")
    ],
    "action": [
        ("ðŸ’³ Ð¡Ð¿Ð¾ÑÐ¾Ð±Ñ‹ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹", "smart_payment"),
        ("ðŸ“„ Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€", "smart_contract"),
        ("ðŸ“ž Ð¡Ð²ÑÐ·Ð°Ñ‚ÑŒÑÑ Ñ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ð¾Ð¼", "smart_manager")
    ]
}


def detect_emotions(text: str) -> list:
    text_lower = text.lower()
    detected = []
    for emotion, patterns in EMOTION_PATTERNS.items():
        for pattern in patterns:
            if pattern in text_lower:
                detected.append(emotion)
                break
    return detected


def detect_objections(text: str) -> list:
    text_lower = text.lower()
    detected = []
    for obj_type, patterns in OBJECTION_PATTERNS.items():
        for pattern in patterns:
            if pattern in text_lower:
                detected.append(obj_type)
                break
    return detected


def detect_momentum(text: str) -> Optional[str]:
    text_lower = text.strip().lower()
    if len(text_lower) <= 15:
        for pattern in MOMENTUM_PATTERNS["low_engagement"]:
            if text_lower == pattern or text_lower.rstrip(".!,") == pattern:
                return "low_engagement"
    for pattern in MOMENTUM_PATTERNS["topic_drift"]:
        if pattern in text_lower:
            return "topic_drift"
    return None


def detect_funnel_stage(user_id: int, user_message: str, message_count: int = 0) -> str:
    text_lower = user_message.lower()

    lead_score = 0
    lead_actions = set()
    try:
        from src.leads import lead_manager
        lead = lead_manager.get_lead(user_id)
        if lead:
            lead_score = lead.score or 0
            events = lead_manager.get_events(user_id) if hasattr(lead_manager, 'get_events') else []
            for ev in events:
                event_type = ev.get("event_type", "") if isinstance(ev, dict) else ""
                lead_actions.add(event_type)
    except Exception:
        pass

    if lead_score >= 60 or any(kw in text_lower for kw in FUNNEL_STAGE_SIGNALS["action"]["keywords"]):
        return "action"

    if lead_score >= 40 or any(kw in text_lower for kw in FUNNEL_STAGE_SIGNALS["decision"]["keywords"]):
        return "decision"

    if any("payment" in a or "lead" in a or "contact" in a for a in lead_actions):
        return "decision"

    if lead_score >= 20 or any(kw in text_lower for kw in FUNNEL_STAGE_SIGNALS["consideration"]["keywords"]):
        return "consideration"

    if any("calc" in a or "portfolio" in a or "price" in a for a in lead_actions):
        return "consideration"

    if any(kw in text_lower for kw in FUNNEL_STAGE_SIGNALS["interest"]["keywords"]):
        return "interest"

    if message_count > FUNNEL_STAGE_SIGNALS["awareness"]["max_messages"]:
        return "interest"

    return "awareness"


def get_social_proof(objections: list, funnel_stage: str) -> str:
    proofs = []
    for obj in objections:
        if obj in SOCIAL_PROOF_TRIGGERS:
            import random
            proof = random.choice(SOCIAL_PROOF_TRIGGERS[obj])
            proofs.append(proof)

    if not proofs and funnel_stage in ("consideration", "decision"):
        import random
        all_proofs = []
        for v in SOCIAL_PROOF_TRIGGERS.values():
            all_proofs.extend(v)
        if all_proofs:
            proofs.append(random.choice(all_proofs))

    if proofs:
        return "[Ð¡ÐžÐ¦Ð˜ÐÐ›Ð¬ÐÐžÐ• Ð”ÐžÐšÐÐ—ÐÐ¢Ð•Ð›Ð¬Ð¡Ð¢Ð’Ðž â€” Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐµÑÑ‚ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾ Ð² Ð¾Ñ‚Ð²ÐµÑ‚Ðµ]\n" + "\n".join(proofs)
    return ""


def build_client_context(user_id: int, username: str = None, first_name: str = None) -> str:
    context_parts = []

    try:
        from src.leads import lead_manager
        lead = lead_manager.get_lead(user_id)
        if lead:
            context_parts.append("[ÐŸÐ ÐžÐ¤Ð˜Ð›Ð¬ ÐšÐ›Ð˜Ð•ÐÐ¢Ð]")
            context_parts.append(f"Ð˜Ð¼Ñ: {lead.first_name or first_name or 'Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾'}")
            if lead.score and lead.score > 0:
                context_parts.append(f"Ð›Ð¸Ð´-ÑÐºÐ¾Ñ€: {lead.score}/100")
            if lead.priority:
                priority_map = {"cold": "Ñ…Ð¾Ð»Ð¾Ð´Ð½Ñ‹Ð¹", "warm": "Ñ‚Ñ‘Ð¿Ð»Ñ‹Ð¹", "hot": "Ð³Ð¾Ñ€ÑÑ‡Ð¸Ð¹", "vip": "VIP"}
                context_parts.append(f"Ð¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð°: {priority_map.get(lead.priority.value, lead.priority.value)}")
            if lead.tags:
                context_parts.append(f"Ð¢ÐµÐ³Ð¸: {', '.join(lead.tags)}")
            if hasattr(lead, 'message_count') and lead.message_count:
                context_parts.append(f"Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹: {lead.message_count}")
    except Exception as e:
        logger.debug(f"Failed to get lead data: {e}")

    try:
        from src.tasks_tracker import tasks_tracker
        progress = tasks_tracker.get_user_progress(user_id)
        if progress and progress.total_coins > 0:
            context_parts.append(f"ÐœÐ¾Ð½ÐµÑ‚Ñ‹: {progress.total_coins} (ÑÐºÐ¸Ð´ÐºÐ° {progress.get_discount_percent()}%)")
    except Exception as e:
        logger.debug(f"Failed to get coins data: {e}")

    try:
        from src.loyalty import loyalty_system
        if loyalty_system.is_returning_customer(user_id):
            context_parts.append("Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: Ð¿Ð¾ÑÑ‚Ð¾ÑÐ½Ð½Ñ‹Ð¹ ÐºÐ»Ð¸ÐµÐ½Ñ‚ (+5% ÑÐºÐ¸Ð´ÐºÐ°)")
        reviews = loyalty_system.get_user_reviews(user_id)
        if reviews:
            context_parts.append(f"ÐžÑÑ‚Ð°Ð²Ð¸Ð» {len(reviews)} Ð¾Ñ‚Ð·Ñ‹Ð²Ð¾Ð²")
    except Exception as e:
        logger.debug(f"Failed to get loyalty data: {e}")

    try:
        from src.referrals import referral_system
        referrals = referral_system.get_referrals_list(user_id)
        if referrals:
            context_parts.append(f"ÐŸÑ€Ð¸Ð²Ñ‘Ð» {len(referrals)} Ñ€ÐµÑ„ÐµÑ€Ð°Ð»Ð¾Ð²")
    except Exception as e:
        logger.debug(f"Failed to get referral data: {e}")

    try:
        from src.leads import lead_manager
        events = lead_manager.get_events(user_id) if hasattr(lead_manager, 'get_events') else []
        if events:
            actions = set()
            for ev in events:
                event_type = ev.get("event_type", "") if isinstance(ev, dict) else ""
                if "calc" in event_type:
                    actions.add("ÑÑ‡Ð¸Ñ‚Ð°Ð» ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ")
                elif "portfolio" in event_type:
                    actions.add("ÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ» Ð¿Ð¾Ñ€Ñ‚Ñ„Ð¾Ð»Ð¸Ð¾")
                elif "price" in event_type:
                    actions.add("ÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ» Ñ†ÐµÐ½Ñ‹")
                elif "payment" in event_type:
                    actions.add("Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ¾Ð²Ð°Ð»ÑÑ Ð¾Ð¿Ð»Ð°Ñ‚Ð¾Ð¹")
                elif "lead" in event_type or "contact" in event_type:
                    actions.add("Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐ» Ð·Ð°ÑÐ²ÐºÑƒ")
            if actions:
                context_parts.append(f"Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ: {', '.join(actions)}")
    except Exception as e:
        logger.debug(f"Failed to get event data: {e}")

    if context_parts:
        return "\n".join(context_parts)
    return ""


def build_objection_hint(user_message: str) -> str:
    objections = detect_objections(user_message)
    if not objections:
        return ""

    hints = []
    for obj in objections:
        if obj in OBJECTION_STRATEGIES:
            hints.append(OBJECTION_STRATEGIES[obj])

    return "\n".join(hints)


def build_emotion_hint(user_message: str) -> str:
    emotions = detect_emotions(user_message)
    if not emotions:
        return ""

    hints = []
    for emo in emotions:
        if emo in EMOTION_HINTS:
            hints.append(EMOTION_HINTS[emo])

    return "\n".join(hints)


def build_full_context(user_id: int, user_message: str, username: str = None, first_name: str = None, message_count: int = 0) -> Optional[str]:
    parts = []

    client_ctx = build_client_context(user_id, username, first_name)
    if client_ctx:
        parts.append(client_ctx)

    funnel_stage = detect_funnel_stage(user_id, user_message, message_count)
    stage_info = FUNNEL_STAGE_SIGNALS.get(funnel_stage, {})
    if stage_info.get("instruction"):
        parts.append(f"\n[Ð¡Ð¢ÐÐ”Ð˜Ð¯ Ð’ÐžÐ ÐžÐÐšÐ˜]\n{stage_info['instruction']}")

    objections = detect_objections(user_message)
    objection_hint = build_objection_hint(user_message)
    if objection_hint:
        parts.append(f"\n[ÐžÐ‘ÐÐÐ Ð£Ð–Ð•ÐÐž Ð’ÐžÐ—Ð ÐÐ–Ð•ÐÐ˜Ð•]\n{objection_hint}")

    social_proof = get_social_proof(objections, funnel_stage)
    if social_proof:
        parts.append(f"\n{social_proof}")

    emotion_hint = build_emotion_hint(user_message)
    if emotion_hint:
        parts.append(f"\n[Ð­ÐœÐžÐ¦Ð˜ÐžÐÐÐ›Ð¬ÐÐ«Ð™ Ð¢ÐžÐ]\n{emotion_hint}")

    momentum = detect_momentum(user_message)
    if momentum and momentum in MOMENTUM_STRATEGIES:
        parts.append(f"\n[MOMENTUM]\n{MOMENTUM_STRATEGIES[momentum]}")

    if parts:
        return "\n".join(parts)
    return None


def get_dynamic_buttons(user_id: int, user_message: str, message_count: int = 0) -> list:
    stage = detect_funnel_stage(user_id, user_message, message_count)
    buttons = DYNAMIC_BUTTONS_BY_STAGE.get(stage, DYNAMIC_BUTTONS_BY_STAGE["awareness"])
    return buttons[:3]


def is_returning_user(user_id: int) -> bool:
    try:
        from src.leads import lead_manager
        lead = lead_manager.get_lead(user_id)
        if lead and hasattr(lead, 'message_count') and lead.message_count and lead.message_count > 5:
            return True
    except Exception:
        pass
    return False


def get_returning_context(user_id: int) -> Optional[str]:
    try:
        from src.session import session_manager
        if user_id in session_manager._sessions:
            session = session_manager._sessions[user_id]
            if session._summary:
                return session._summary
    except Exception:
        pass

    try:
        import os
        DATABASE_URL = os.environ.get("DATABASE_URL")
        if DATABASE_URL:
            from src.database import fetch_one
            row = fetch_one(
                "SELECT summary FROM conversation_summaries WHERE telegram_id = %s",
                (user_id,)
            )
            if row and row.get("summary"):
                return row["summary"]
    except Exception:
        pass
    return None
