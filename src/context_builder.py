import logging
from typing import Optional, List, Dict

logger = logging.getLogger(__name__)


OBJECTION_PATTERNS = {
    "price": [
        "–¥–æ—Ä–æ–≥–æ", "–¥–æ—Ä–æ–≥–æ–≤–∞—Ç–æ", "—Å–ª–∏—à–∫–æ–º –¥–æ—Ä–æ–≥–æ", "—Ü–µ–Ω–∞ –∫—É—Å–∞–µ—Ç—Å—è", "–Ω–µ –ø–æ—Ç—è–Ω—É",
        "–±—é–¥–∂–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω", "–Ω–µ—Ç –±—é–¥–∂–µ—Ç–∞", "–Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç", "expensive", "costly",
        "–º–Ω–æ–≥–æ –¥–µ–Ω–µ–≥", "–∑–∞ —Ç–∞–∫–∏–µ –¥–µ–Ω—å–≥–∏", "–¥–µ—à–µ–≤–ª–µ", "cheaper", "–∑–∞–≤—ã—à–µ–Ω",
        "–ø–µ—Ä–µ–ø–ª–∞—Ç–∞", "–Ω–µ —Å—Ç–æ–∏—Ç —Å—Ç–æ–ª—å–∫–æ", "could be cheaper", "too much",
        "–Ω–µ—Ç —Ç–∞–∫–∏—Ö –¥–µ–Ω–µ–≥", "–Ω–µ –ø–æ –∫–∞—Ä–º–∞–Ω—É", "–¥–æ—Ä–æ–≥–æ–≤–∞—Ç"
    ],
    "delay": [
        "–ø–æ–¥—É–º–∞—é", "–Ω–∞–¥–æ –ø–æ–¥—É–º–∞—Ç—å", "–ø–æ–∑–∂–µ", "–Ω–µ —Å–µ–π—á–∞—Å", "–ø–æ—Ç–æ–º",
        "—á–µ—Ä–µ–∑ –º–µ—Å—è—Ü", "—á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é", "–Ω–∞ –¥–Ω—è—Ö", "–≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑",
        "–ø–æ–∫–∞ –Ω–µ –≥–æ—Ç–æ–≤", "–µ—â—ë —Ä–∞–Ω–æ", "—Ä–∞–Ω–æ –µ—â—ë", "think about it",
        "later", "not now", "need time", "–Ω—É–∂–Ω–æ –≤—Ä–µ–º—è", "–Ω–µ —Å–ø–µ—à—É"
    ],
    "competitor": [
        "—É –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤", "–≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ", "–¥—Ä—É–≥–∞—è —Å—Ç—É–¥–∏—è", "–¥—Ä—É–≥–∏–µ –¥–µ–ª–∞—é—Ç",
        "–Ω–∞—à—ë–ª –¥–µ—à–µ–≤–ª–µ", "–ø—Ä–µ–¥–ª–∞–≥–∞—é—Ç –¥–µ—à–µ–≤–ª–µ", "–µ—Å—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã", "–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤",
        "freelancer", "—Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä", "–Ω–∞ upwork", "fiverr", "–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç",
        "competitor", "someone else", "other company", "–¥—Ä—É–≥–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫"
    ],
    "doubt": [
        "–Ω–µ —É–≤–µ—Ä–µ–Ω", "—Å–æ–º–Ω–µ–≤–∞—é—Å—å", "–∞ —Ç–æ—á–Ω–æ", "–≥–∞—Ä–∞–Ω—Ç–∏–∏", "–∞ –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è",
        "–∞ –≤–¥—Ä—É–≥", "—Ä–∏—Å–∫", "—Å—Ç—Ä–∞—à–Ω–æ", "–±–æ—é—Å—å", "–Ω–µ –∑–Ω–∞—é –Ω—É–∂–Ω–æ –ª–∏",
        "—Å—Ç–æ–∏—Ç –ª–∏", "worth it", "not sure", "doubt", "guarantee",
        "–∞ –∑–∞—á–µ–º", "–Ω—É–∂–Ω–æ –ª–∏ –≤–æ–æ–±—â–µ", "–º–æ–∂–µ—Ç –Ω–µ –Ω–∞–¥–æ"
    ],
    "trust": [
        "–∞ –≤—ã —Ä–µ–∞–ª—å–Ω—ã–µ", "–º–æ—à–µ–Ω–Ω–∏–∫–∏", "–∫–∏–Ω–µ—Ç–µ", "–æ–±–º–∞–Ω", "—Ä–∞–∑–≤–æ–¥",
        "–º–æ–∂–Ω–æ –¥–æ–≤–µ—Ä—è—Ç—å", "–æ—Ç–∑—ã–≤—ã –Ω–∞—Å—Ç–æ—è—â–∏–µ", "scam", "fraud", "trust",
        "–∫—Ç–æ –≤—ã", "–∫–æ–º–ø–∞–Ω–∏—è –Ω–∞—Å—Ç–æ—è—â–∞—è", "–∞ –µ—Å—Ç—å –æ—Ñ–∏—Å", "—é—Ä –ª–∏—Ü–æ"
    ],
    "free": [
        "–±–µ—Å–ø–ª–∞—Ç–Ω–æ", "–±–µ–∑ –¥–µ–Ω–µ–≥", "–∑–∞ 0", "free", "no cost",
        "–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π", "—Å–¥–µ–ª–∞—Ç—å —Å–∞–º–æ–º—É –±–µ—Å–ø–ª–∞—Ç–Ω–æ", "–±–µ–∑ –≤–ª–æ–∂–µ–Ω–∏–π",
        "–µ—Å—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ", "–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä", "tilda", "—Ç–∏–ª—å–¥–∞", "wix"
    ],
    "diy": [
        "—Å–∞–º —Å–¥–µ–ª–∞—é", "—Å–∞–º–∏ —Å–¥–µ–ª–∞–µ–º", "—Å–≤–æ–∏–º–∏ —Å–∏–ª–∞–º–∏", "in-house",
        "—É –Ω–∞—Å –µ—Å—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫", "–Ω–∞—à –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç", "—Å–∞–º–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–µ–º",
        "–Ω–∞–π–º—É —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä–∞", "—Å–∞–º –Ω–∞–ø–∏—à—É", "no-code", "–Ω–æ—É-–∫–æ–¥"
    ],
    "timing": [
        "–Ω–µ —Å–µ–∑–æ–Ω", "–∫—Ä–∏–∑–∏—Å", "—Å–µ–π—á–∞—Å –Ω–µ –≤—Ä–µ–º—è", "–ø–æ—Å–ª–µ –Ω–æ–≤–æ–≥–æ –≥–æ–¥–∞",
        "–ø–æ—Å–ª–µ –ª–µ—Ç–∞", "–∫–æ–≥–¥–∞ –±—É–¥—É—Ç –¥–µ–Ω—å–≥–∏", "–∫–æ–≥–¥–∞ —Ä–∞—Å–∫—Ä—É—Ç–∏–º—Å—è",
        "–±–∏–∑–Ω–µ—Å —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è", "–µ—â—ë –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å"
    ]
}

OBJECTION_STRATEGIES = {
    "price": "–°–¢–†–ê–¢–ï–ì–ò–Ø_–¶–ï–ù–ê: –ù–ï —Å–Ω–∏–∂–∞–π —Ü–µ–Ω—É! –ò—Å–ø–æ–ª—å–∑—É–π –º–æ–¥–µ–ª—å —Ç—Ä—ë—Ö –º–æ–∑–≥–æ–≤:\n‚Ä¢ –†–µ–ø—Ç–∏–ª—å–Ω—ã–π: \"–î–æ–≥–æ–≤–æ—Ä, –≥–∞—Ä–∞–Ω—Ç–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã, 14 –¥–Ω–µ–π –ø—Ä–∞–≤–æ–∫ ‚Äî –≤—ã –Ω–∏—á–µ–º –Ω–µ —Ä–∏—Å–∫—É–µ—Ç–µ\"\n‚Ä¢ –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π: –í–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (\"–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ: –∫–ª–∏–µ–Ω—Ç—ã –∑–∞–∫–∞–∑—ã–≤–∞—é—Ç –≤ 2 –∫–ª–∏–∫–∞, 24/7\")\n‚Ä¢ –†–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π: –ü–æ–∫–∞–∂–∏ ROI (\"–û–¥–∏–Ω –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–∫–∞–∑ –≤ –¥–µ–Ω—å –ø–æ 2000‚ÇΩ = 60 000‚ÇΩ/–º–µ—Å. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–∫—É–ø–∞–µ—Ç—Å—è –∑–∞ 2-3 –º–µ—Å—è—Ü–∞\")\n–Ø–∫–æ—Ä—å: –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∑–æ–≤–∏ –ø–æ–ª–Ω—ã–π –ø–∞–∫–µ—Ç, –ø–æ—Ç–æ–º –ø—Ä–µ–¥–ª–æ–∂–∏ MVP. –£–ø–æ–º—è–Ω–∏ —Ä–∞—Å—Å—Ä–æ—á–∫—É –∏ —Å–∏—Å—Ç–µ–º—É —Å–∫–∏–¥–æ–∫ –∑–∞ –º–æ–Ω–µ—Ç—ã.",
    "delay": "–°–¢–†–ê–¢–ï–ì–ò–Ø_–û–¢–õ–û–ñ–ò–¢–¨: –ò—Å–ø–æ–ª—å–∑—É–π –Ω–µ–π—Ä–æ-–ø–æ–¥—Ö–æ–¥ –∫ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏:\n‚Ä¢ –†–µ–ø—Ç–∏–ª—å–Ω—ã–π: –ú—è–≥–∫–∞—è –ø–æ—Ç–µ—Ä—è (\"–ö–∞–∂–¥—ã–π –¥–µ–Ω—å –±–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Äî —ç—Ç–æ X –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤\")\n‚Ä¢ –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π: –ö–æ–Ω—Ç—Ä–∞—Å—Ç –±—É–¥—É—â–µ–≥–æ (\"–ß–µ—Ä–µ–∑ 10 –¥–Ω–µ–π —É –≤–∞—Å —É–∂–µ —Ä–∞–±–æ—Ç–∞—é—â–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\")\n‚Ä¢ –†–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π: –§–∞–∫—Ç (\"–ö–æ–º–∞–Ω–¥–∞ —Å–µ–π—á–∞—Å —Å–≤–æ–±–æ–¥–Ω–∞, —á–µ—Ä–µ–∑ 2 –Ω–µ–¥–µ–ª–∏ ‚Äî –æ—á–µ—Ä–µ–¥—å –¥–æ –º–µ—Å—è—Ü–∞\")\n–ú–∏–∫—Ä–æ-–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ: –ü—Ä–µ–¥–ª–æ–∂–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —à–∞–≥ ‚Äî —Ä–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏–ª–∏ –¢–ó.",
    "competitor": "–°–¢–†–ê–¢–ï–ì–ò–Ø_–ö–û–ù–ö–£–†–ï–ù–¢: –ù–µ –∫—Ä–∏—Ç–∏–∫—É–π! –ó–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã (\"–ß—Ç–æ –∏–º–µ–Ω–Ω–æ –ø—Ä–µ–¥–ª–∞–≥–∞—é—Ç?\"). –ü–æ–¥—á–µ—Ä–∫–Ω–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å:\n‚Ä¢ –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –Ω–∞ Telegram Mini Apps (–Ω–µ –Ω–∞ –≤—Å—ë–º –ø–æ–¥—Ä—è–¥)\n‚Ä¢ 7-15 –¥–Ω–µ–π (–Ω–µ –º–µ—Å—è—Ü—ã)\n‚Ä¢ Apple-–¥–∏–∑–∞–π–Ω, –Ω–µ—Ç –∫–æ–º–∏—Å—Å–∏–π –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤ (—ç–∫–æ–Ω–æ–º–∏—è 15-25%)\n‚Ä¢ –î–æ–≥–æ–≤–æ—Ä + –≥–∞—Ä–∞–Ω—Ç–∏—è + —ç—Ç–∞–ø–Ω–∞—è –æ–ø–ª–∞—Ç–∞\n–°–æ—Ü–∏–∞–ª—å–Ω–æ–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ: –ù–∞–∑–æ–≤–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∫–µ–π—Å—ã (Radiance, TimeElite, GlowSpa).",
    "doubt": "–°–¢–†–ê–¢–ï–ì–ò–Ø_–°–û–ú–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é + —Å–æ—Ü–∏–∞–ª—å–Ω–æ–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ:\n‚Ä¢ \"–û–¥–∏–Ω –Ω–∞—à –∫–ª–∏–µ–Ω—Ç –∏–∑ [–ø–æ—Ö–æ–∂–∞—è –Ω–∏—à–∞] —Ç–æ–∂–µ —Å–æ–º–Ω–µ–≤–∞–ª—Å—è. –ß–µ—Ä–µ–∑ –º–µ—Å—è—Ü –µ–≥–æ –≤—ã—Ä—É—á–∫–∞ –≤—ã—Ä–æ—Å–ª–∞ –Ω–∞ 40%\"\n‚Ä¢ –ü—Ä–µ–¥–ª–æ–∂–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é (schedule_consultation)\n‚Ä¢ –£–ø–æ–º—è–Ω–∏ –≥–∞—Ä–∞–Ω—Ç–∏—é –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã\n‚Ä¢ –ü–æ–∫–∞–∂–∏ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ (show_portfolio)\n–ú–∏–∫—Ä–æ-–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ: \"–î–∞–≤–∞–π—Ç–µ –ø—Ä–æ—Å—Ç–æ –ø–æ—Å—á–∏—Ç–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å ‚Äî –Ω–∏ –∫ —á–µ–º—É –Ω–µ –æ–±—è–∑—ã–≤–∞–µ—Ç\"",
    "trust": "–°–¢–†–ê–¢–ï–ì–ò–Ø_–î–û–í–ï–†–ò–ï: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –æ—Ç–∫—Ä—ã—Ç–æ—Å—Ç—å:\n‚Ä¢ –ü–æ–∫–∞–∂–∏ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ (show_portfolio)\n‚Ä¢ –£–ø–æ–º—è–Ω–∏ –¥–æ–≥–æ–≤–æ—Ä (/contract)\n‚Ä¢ –≠—Ç–∞–ø–Ω–∞—è –æ–ø–ª–∞—Ç–∞ (35%+65%) ‚Äî \"–ü–ª–∞—Ç–∏—Ç–µ –±–æ–ª—å—à—É—é —á–∞—Å—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —É–≤–∏–¥–∏—Ç–µ –≥–æ—Ç–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç\"\n‚Ä¢ 14 –¥–Ω–µ–π –ø—Ä–∞–≤–æ–∫ –ø–æ—Å–ª–µ —Å–¥–∞—á–∏\n‚Ä¢ –ü—Ä–µ–¥–ª–æ–∂–∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ–º–æ-–≤–µ—Ä—Å–∏–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤",
    "free": "–°–¢–†–ê–¢–ï–ì–ò–Ø_–ë–ï–°–ü–õ–ê–¢–ù–û–ï: –ù–µ –æ–±–µ—Å—Ü–µ–Ω–∏–≤–∞–π –∑–∞–ø—Ä–æ—Å! –ü–æ–∫–∞–∂–∏ —Ä–∞–∑–Ω–∏—Ü—É:\n‚Ä¢ \"–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã (Tilda, Wix) –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –≤–Ω—É—Ç—Ä–∏ Telegram ‚Äî –∫–ª–∏–µ–Ω—Ç—É –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –Ω–∞ —Å–∞–π—Ç, —ç—Ç–æ —Ç–µ—Ä—è–µ—Ç 70% –∫–æ–Ω–≤–µ—Ä—Å–∏–∏\"\n‚Ä¢ \"–ë–µ—Å–ø–ª–∞—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ = –≤–∞—à–µ –≤—Ä–µ–º—è + –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª + –±–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫–∏\"\n‚Ä¢ \"Mini App –≤ Telegram ‚Äî —ç—Ç–æ –Ω–µ —Å–∞–π—Ç, —ç—Ç–æ –Ω–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞\"\n–ü—Ä–µ–¥–ª–æ–∂–∏ MVP –∫–∞–∫ –¥–æ—Å—Ç—É–ø–Ω—ã–π –≤—Ö–æ–¥: —à–∞–±–ª–æ–Ω –º–∞–≥–∞–∑–∏–Ω–∞ –æ—Ç 150–∫ —Å —Ä–∞—Å—Å—Ä–æ—á–∫–æ–π (–ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ 52 500‚ÇΩ).",
    "diy": "–°–¢–†–ê–¢–ï–ì–ò–Ø_–°–ê–ú–ò: –£–≤–∞–∂–∞–π —Ä–µ—à–µ–Ω–∏–µ, –Ω–æ –ø–æ–∫–∞–∂–∏ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å:\n‚Ä¢ \"–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ Mini App —Å–∏–ª–∞–º–∏ –æ–¥–Ω–æ–≥–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ ‚Äî 2-4 –º–µ—Å—è—Ü–∞. –£ –Ω–∞—Å ‚Äî 7-15 –¥–Ω–µ–π\"\n‚Ä¢ \"No-code –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç Telegram Mini Apps API –Ω–∞—Ç–∏–≤–Ω–æ\"\n‚Ä¢ \"–°—Ç–æ–∏–º–æ—Å—Ç—å —à—Ç–∞—Ç–Ω–æ–≥–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞: 150-250–∫/–º–µ—Å. –ù–∞—à –ø—Ä–æ–µ–∫—Ç ‚Äî —Ä–∞–∑–æ–≤–∞—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è\"\nValue-first: –ü—Ä–µ–¥–ª–æ–∂–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –¢–ó ‚Äî \"–ü—Ä–∏–≥–æ–¥–∏—Ç—Å—è –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ\"",
    "timing": "–°–¢–†–ê–¢–ï–ì–ò–Ø_–í–†–ï–ú–Ø: –ü–æ–∫–∞–∂–∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–∂–∏–¥–∞–Ω–∏—è:\n‚Ä¢ \"–ö–∞–∂–¥—ã–π –º–µ—Å—è—Ü –±–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Äî —ç—Ç–æ X —É–ø—É—â–µ–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∫—É–ø–∞—é—Ç —É –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤\"\n‚Ä¢ \"–õ—É—á—à–µ–µ –≤—Ä–µ–º—è ‚Äî –∫–æ–≥–¥–∞ –±–∏–∑–Ω–µ—Å —Ä–∞—Å—Ç—ë—Ç, –∞ –Ω–µ –∫–æ–≥–¥–∞ —É–∂–µ –æ—Ç—Å—Ç–∞–ª–∏\"\n‚Ä¢ \"–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ 7-15 –¥–Ω–µ–π ‚Äî –∫ [–¥–∞—Ç–∞ —á–µ—Ä–µ–∑ 2 –Ω–µ–¥–µ–ª–∏] —É –≤–∞—Å —É–∂–µ —Ä–∞–±–æ—Ç–∞—é—â–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\"\n–ú–∏–∫—Ä–æ-–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ: \"–î–∞–≤–∞–π—Ç–µ —Å–µ–π—á–∞—Å –ø—Ä–æ—Å—Ç–æ –æ–±—Å—É–¥–∏–º –∏–¥–µ—é ‚Äî –Ω–∏ –∫ —á–µ–º—É –Ω–µ –æ–±—è–∑—ã–≤–∞–µ—Ç\""
}


EMOTION_PATTERNS = {
    "frustrated": [
        "–Ω–∞–¥–æ–µ–ª–æ", "—É—Å—Ç–∞–ª", "–±–µ—Å–∏—Ç", "—Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç", "—É–∂–∞—Å", "–∫–æ—à–º–∞—Ä",
        "–ø–ª–æ—Ö–æ", "–æ—Ç–≤—Ä–∞—Ç–∏—Ç–µ–ª—å–Ω–æ", "–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ", "frustrated", "annoyed",
        "disappointed", "terrible", "worst", "—Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω", "–æ—Ç—Å—Ç–æ–π",
        "–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç", "–æ–ø—è—Ç—å", "—Å–Ω–æ–≤–∞", "—Å–∫–æ–ª—å–∫–æ –º–æ–∂–Ω–æ"
    ],
    "excited": [
        "–∫—Ä—É—Ç–æ", "–æ—Ñ–∏–≥–µ–Ω–Ω–æ", "–≤–∞—É", "–ø–æ—Ç—Ä—è—Å–∞—é—â–µ", "—Å—É–ø–µ—Ä", "–∫–ª–∞—Å—Å",
        "–≤–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ", "—à–∏–∫–∞—Ä–Ω–æ", "amazing", "awesome", "wow", "cool",
        "fantastic", "love it", "–æ–±–∞–ª–¥–µ—Ç—å", "–≤–æ—Å—Ç–æ—Ä–≥",
        "—Ç–æ–ø", "–±–æ–º–±–∞", "–æ–≥–æ–Ω—å", "–æ—Ç–ª–∏—á–Ω–æ"
    ],
    "confused": [
        "–Ω–µ –ø–æ–Ω–∏–º–∞—é", "–∑–∞–ø—É—Ç–∞–ª—Å—è", "—Å–ª–æ–∂–Ω–æ", "–Ω–µ–ø–æ–Ω—è—Ç–Ω–æ", "–æ–±—ä—è—Å–Ω–∏—Ç–µ",
        "–∫–∞–∫ —ç—Ç–æ", "—á—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç", "–Ω–µ —è—Å–Ω–æ", "confused", "don't understand",
        "what do you mean", "unclear", "–∞ –º–æ–∂–Ω–æ –ø—Ä–æ—â–µ", "–Ω–µ —Ä–∞–∑–±–∏—Ä–∞—é—Å—å",
        "—Ö–∑", "–Ω–µ –∑–Ω–∞—é"
    ],
    "urgent": [
        "—Å—Ä–æ—á–Ω–æ", "–±—ã—Å—Ç—Ä–µ–µ", "—Å–∫–æ—Ä–µ–µ", "—Å–µ–π—á–∞—Å", "–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ",
        "urgent", "asap", "hurry", "deadline", "–≥–æ—Ä–∏—Ç", "–≤—á–µ—Ä–∞ –Ω—É–∂–Ω–æ –±—ã–ª–æ",
        "–∑–∞–≤—Ç—Ä–∞ –∑–∞–ø—É—Å–∫", "–≤—Ä–µ–º—è –ø–æ–¥–∂–∏–º–∞–µ—Ç"
    ],
    "skeptical": [
        "–≤–µ—Ä–∏—Ç—Å—è —Å —Ç—Ä—É–¥–æ–º", "—Å–æ–º–Ω–µ–≤–∞—é—Å—å", "–∑–≤—É—á–∏—Ç –∫–∞–∫", "–Ω—É-–Ω—É",
        "–¥–∞ –ª–∞–¥–Ω–æ", "—Å–µ—Ä—å—ë–∑–Ω–æ?", "–≤—Ä—è–¥ –ª–∏", "skeptical", "really?",
        "–º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ", "–∞–≥–∞ –∫–æ–Ω–µ—á–Ω–æ", "—Å–ª–∏—à–∫–æ–º —Ö–æ—Ä–æ—à–æ"
    ]
}

EMOTION_HINTS = {
    "frustrated": "–¢–û–ù: –ö–ª–∏–µ–Ω—Ç —Ä–∞–∑–¥—Ä–∞–∂—ë–Ω. –ú–æ–¥–µ–ª—å —Ç—Ä—ë—Ö –º–æ–∑–≥–æ–≤: –æ–±—Ä–∞—Ç–∏—Å—å –∫ —Ä–µ–ø—Ç–∏–ª—å–Ω–æ–º—É (—É–±–µ—Ä–∏ —É–≥—Ä–æ–∑—É ‚Äî \"–ü–æ–Ω–∏–º–∞—é, —ç—Ç–æ –Ω–µ–ø—Ä–∏—è—Ç–Ω–æ\"), –ø–æ—Ç–æ–º –∫ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–º—É (—ç–º–ø–∞—Ç–∏—è ‚Äî \"–î–∞–≤–∞–π—Ç–µ —è –ø–æ–º–æ–≥—É —Ä–µ—à–∏—Ç—å —ç—Ç–æ\"), –ø–æ—Ç–æ–º –∫ —Ä–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–º—É (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–ª–∞–Ω). –ù–ï –æ–ø—Ä–∞–≤–¥—ã–≤–∞–π—Å—è.",
    "excited": "–¢–û–ù: –ö–ª–∏–µ–Ω—Ç –≤–æ–æ–¥—É—à–µ–≤–ª—ë–Ω! –ò—Å–ø–æ–ª—å–∑—É–π –º–æ–º–µ–Ω—Ç: –ø–æ–¥–¥–µ—Ä–∂–∏ —ç–Ω–µ—Ä–≥–∏—é –∏ —Å—Ä–∞–∑—É –ø—Ä–µ–¥–ª–æ–∂–∏ –º–∏–∫—Ä–æ-–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ (\"–î–∞–≤–∞–π—Ç–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –ø–æ—Å—á–∏—Ç–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å?\"). Foot-in-the-door: –º–∞–ª–µ–Ω—å–∫–æ–µ \"–¥–∞\" –≤–µ–¥—ë—Ç –∫ –±–æ–ª—å—à–æ–º—É.",
    "confused": "–¢–û–ù: –ö–ª–∏–µ–Ω—Ç –∑–∞–ø—É—Ç–∞–Ω. –£–ø—Ä–æ—Å—Ç–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–π –∞–Ω–∞–ª–æ–≥–∏–∏ –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏ (\"–≠—Ç–æ –∫–∞–∫ –≤–∏—Ç—Ä–∏–Ω–∞ –º–∞–≥–∞–∑–∏–Ω–∞, –Ω–æ –ø—Ä—è–º–æ –≤ Telegram\"). –û–¥–∏–Ω —Ç–µ–∑–∏—Å –∑–∞ —Ä–∞–∑. –°–ø—Ä–æ—Å–∏ —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ.",
    "urgent": "–¢–û–ù: –£ –∫–ª–∏–µ–Ω—Ç–∞ —Å—Ä–æ—á–Ω–æ—Å—Ç—å. –î–µ–π—Å—Ç–≤—É–π –±—ã—Å—Ç—Ä–æ: –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ä–æ–∫–∏ (\"–ó–∞–ø—É—Å—Ç–∏–º –∑–∞ 7-10 –¥–Ω–µ–π\"), –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏ (\"–û—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É —Å–µ–π—á–∞—Å ‚Äî –Ω–∞—á–Ω—ë–º –∑–∞–≤—Ç—Ä–∞\"). –ë–µ–∑ –ª–∏—à–Ω–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.",
    "skeptical": "–¢–û–ù: –ö–ª–∏–µ–Ω—Ç —Å–∫–µ–ø—Ç–∏—á–µ–Ω. –¢–æ–ª—å–∫–æ —Ñ–∞–∫—Ç—ã –∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞. –°–æ—Ü–∏–∞–ª—å–Ω–æ–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ: –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∫–µ–π—Å—ã —Å —Ü–∏—Ñ—Ä–∞–º–∏. –ß–µ—Å—Ç–Ω–æ—Å—Ç—å: \"–ù–µ –±—É–¥—É –æ–±–µ—â–∞—Ç—å —á—É–¥–µ—Å, –Ω–æ –≤–æ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤...\""
}


SOCIAL_PROOF_TRIGGERS = {
    "doubt": [
        "–û–¥–∏–Ω –Ω–∞—à –∫–ª–∏–µ–Ω—Ç –∏–∑ —Å—Ñ–µ—Ä—ã —É—Å–ª—É–≥ –∑–∞ –ø–µ—Ä–≤—ã–π –º–µ—Å—è—Ü –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –ø–æ–ª—É—á–∏–ª 47 –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤ —á–µ—Ä–µ–∑ Mini App ‚Äî –ø—Ä–∏ —Å—Ä–µ–¥–Ω–µ–º —á–µ–∫–µ 3 500‚ÇΩ —ç—Ç–æ +164 000‚ÇΩ –≤—ã—Ä—É—á–∫–∏.",
        "Radiance (–º–∞–≥–∞–∑–∏–Ω –æ–¥–µ–∂–¥—ã) ‚Äî –∑–∞–ø—É—Å—Ç–∏–ª–∏ –∑–∞ 10 –¥–Ω–µ–π, –≤ –ø–µ—Ä–≤—É—é –Ω–µ–¥–µ–ª—é 200+ –∑–∞–∫–∞–∑–æ–≤. –í–ª–∞–¥–µ–ª–µ—Ü —Å–∫–∞–∑–∞–ª: \"–ñ–∞–ª–µ—é, —á—Ç–æ –Ω–µ —Å–¥–µ–ª–∞–ª —Ä–∞–Ω—å—à–µ\".",
        "–£ 87% –Ω–∞—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–∫—É–ø–∞–µ—Ç—Å—è –≤ –ø–µ—Ä–≤—ã–µ 2-3 –º–µ—Å—è—Ü–∞ ‚Äî –º—ã —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ —Å—á–∏—Ç–∞–µ–º ROI –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º."
    ],
    "competitor": [
        "–ù–∞—à–µ –æ—Ç–ª–∏—á–∏–µ: –º—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ Telegram Mini Apps. –ù–µ –¥–µ–ª–∞–µ–º —Å–∞–π—Ç—ã, –Ω–µ –¥–µ–ª–∞–µ–º –º–æ–±–∏–ª—å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Äî —Ç–æ–ª—å–∫–æ Telegram. –ü–æ—ç—Ç–æ–º—É –¥–µ–ª–∞–µ–º –∑–∞ 7-15 –¥–Ω–µ–π —Ç–æ, —á—Ç–æ –¥—Ä—É–≥–∏–µ –¥–µ–ª–∞—é—Ç –∑–∞ 2-3 –º–µ—Å—è—Ü–∞.",
        "–í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤ (WB, Ozon), –≤ Telegram Mini App –Ω–µ—Ç –∫–æ–º–∏—Å—Å–∏–π 15-25%. –í—Å—è –≤—ã—Ä—É—á–∫–∞ ‚Äî –≤–∞—à–∞.",
        "–§—Ä–∏–ª–∞–Ω—Å–µ—Ä –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –¥–µ—à–µ–≤–ª–µ, –Ω–æ: –Ω–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–∞, –Ω–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏, –Ω–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏, —Å—Ä–æ–∫–∏ –ø–ª—ã–≤—É—Ç. –£ –Ω–∞—Å ‚Äî –¥–æ–≥–æ–≤–æ—Ä, 35%+65% –æ–ø–ª–∞—Ç–∞, 14 –¥–Ω–µ–π –ø—Ä–∞–≤–æ–∫."
    ],
    "trust": [
        "–£ –Ω–∞—Å –±–æ–ª–µ–µ 20 –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤: Radiance, TimeElite, GlowSpa, DeluxeDine. –í—Å–µ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ.",
        "–†–∞–±–æ—Ç–∞–µ–º –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É. –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ 35% ‚Äî –¥–∏–∑–∞–π–Ω –∏ –ø—Ä–æ—Ç–æ—Ç–∏–ø. –û—Å—Ç–∞–ª—å–Ω—ã–µ 65% ‚Äî —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –≤—ã –æ–¥–æ–±—Ä–∏—Ç–µ –≥–æ—Ç–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.",
        "14 –¥–Ω–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –ø—Ä–∞–≤–æ–∫ –ø–æ—Å–ª–µ —Å–¥–∞—á–∏. –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ —É—Å—Ç—Ä–æ–∏—Ç ‚Äî –≤–µ—Ä–Ω—ë–º –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—É."
    ],
    "price": [
        "–î–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è: —à—Ç–∞—Ç–Ω—ã–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ç–æ–∏—Ç 150-250–∫/–º–µ—Å –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç 2-4 –º–µ—Å—è—Ü–∞. –ù–∞—à –ø—Ä–æ–µ–∫—Ç ‚Äî —Ä–∞–∑–æ–≤–∞—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è –æ—Ç 150–∫ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ 7-15 –¥–Ω–µ–π.",
        "–°—Ä–µ–¥–Ω–∏–π ROI –Ω–∞—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ ‚Äî 300% –∑–∞ –ø–µ—Ä–≤—ã–π –≥–æ–¥. –ü—Ä–∏ —Å—Ä–µ–¥–Ω–µ–º —á–µ–∫–µ 2000‚ÇΩ –∏ 3 –¥–æ–ø. –∑–∞–∫–∞–∑–∞—Ö –≤ –¥–µ–Ω—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞ 150–∫ –æ–∫—É–ø–∞–µ—Ç—Å—è –∑–∞ 25 –¥–Ω–µ–π.",
        "–†–∞—Å—Å—Ä–æ—á–∫–∞: –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –≤—Å–µ–≥–æ 52 500‚ÇΩ (35%) –∑–∞ –º–∞–≥–∞–∑–∏–Ω. –û—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –∫–æ–≥–¥–∞ —É–≤–∏–¥–∏—Ç–µ –≥–æ—Ç–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç."
    ]
}


FUNNEL_STAGE_SIGNALS = {
    "awareness": {
        "keywords": [
            "–ø—Ä–∏–≤–µ—Ç", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ", "–¥–æ–±—Ä—ã–π", "hello", "hi",
            "—á—Ç–æ –≤—ã –¥–µ–ª–∞–µ—Ç–µ", "—á–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç–µ—Å—å", "—á—Ç–æ —Ç–∞–∫–æ–µ",
            "—Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ", "–∫—Ç–æ –≤—ã"
        ],
        "max_messages": 3,
        "instruction": "–°–¢–ê–î–ò–Ø: –ó–ù–ê–ö–û–ú–°–¢–í–û (Awareness)\n–ó–∞–¥–∞—á–∞: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç –∏ –ø–æ–Ω—è—Ç—å –±–∏–∑–Ω–µ—Å –∫–ª–∏–µ–Ω—Ç–∞.\nSPIN-—Ñ–∞–∑–∞: Situation ‚Äî –∑–∞–¥–∞–≤–∞–π –æ—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –±–∏–∑–Ω–µ—Å–µ.\n–¢–æ–Ω: –¢—ë–ø–ª—ã–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –ª—é–±–æ–ø—ã—Ç–Ω—ã–π.\n–¶–µ–ª—å –≤–æ–ø—Ä–æ—Å–∞: –£–∑–Ω–∞—Ç—å —Ç–∏–ø –±–∏–∑–Ω–µ—Å–∞ –∏ —Ç–µ–∫—É—â—É—é —Å–∏—Ç—É–∞—Ü–∏—é.\n–ü—Ä–∏–º–µ—Ä: \"–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, –∫–∞–∫–æ–π —É –≤–∞—Å –±–∏–∑–Ω–µ—Å? –ß–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç–µ—Å—å?\"\n–ú–∏–∫—Ä–æ-–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ: –í–æ–≤–ª–µ—á—å –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä."
    },
    "interest": {
        "keywords": [
            "—Ü–µ–Ω–∞", "—Å—Ç–æ–∏–º–æ—Å—Ç—å", "—Å–∫–æ–ª—å–∫–æ", "–ø—Ä–∞–π—Å", "—Ç–∞—Ä–∏—Ñ",
            "—Å—Ä–æ–∫–∏", "—Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏", "–∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–æ",
            "—Ñ—É–Ω–∫—Ü–∏–∏", "–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏", "—á—Ç–æ —É–º–µ–µ—Ç", "–º–æ–∂–Ω–æ –ª–∏",
            "price", "cost", "how much", "features"
        ],
        "max_messages": 8,
        "instruction": "–°–¢–ê–î–ò–Ø: –ò–ù–¢–ï–†–ï–° (Interest)\n–ó–∞–¥–∞—á–∞: –î–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫—É –∏ –≤—ã—è–≤–∏—Ç—å –±–æ–ª—å.\nSPIN-—Ñ–∞–∑–∞: Problem ‚Äî –∏—â–∏ –ø—Ä–æ–±–ª–µ–º—É –∫–ª–∏–µ–Ω—Ç–∞ (\"–° –∫–∞–∫–∏–º–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—è–º–∏ —Å—Ç–∞–ª–∫–∏–≤–∞–µ—Ç–µ—Å—å –≤ –ø—Ä–æ–¥–∞–∂–∞—Ö?\").\n–¢–æ–Ω: –≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π, –Ω–æ –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π.\n–¶–µ–ª—å –≤–æ–ø—Ä–æ—Å–∞: –ü–æ–Ω—è—Ç—å –ø—Ä–æ–±–ª–µ–º—É –∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å.\n–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: calculate_price, show_portfolio.\n–ú–∏–∫—Ä–æ-–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ: \"–•–æ—Ç–∏—Ç–µ –ø–æ—Å—á–∏—Ç–∞—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–¥ –≤–∞—à–∏ –∑–∞–¥–∞—á–∏?\""
    },
    "consideration": {
        "keywords": [
            "—Å—Ä–∞–≤–Ω–∏—Ç—å", "–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤", "–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç", "–¥—Ä—É–≥–∏–µ",
            "–∞ –µ—Å–ª–∏", "–≥–∞—Ä–∞–Ω—Ç–∏–∏", "–∞ —Ç–æ—á–Ω–æ", "–ø–æ–¥—É–º–∞—é", "–¥—É–º–∞—é",
            "—Å–æ–º–Ω–µ–≤–∞—é—Å—å", "–Ω–µ —É–≤–µ—Ä–µ–Ω", "—Ä–∏—Å–∫", "compare"
        ],
        "max_messages": 15,
        "instruction": "–°–¢–ê–î–ò–Ø: –†–ê–°–°–ú–û–¢–†–ï–ù–ò–ï (Consideration)\n–ó–∞–¥–∞—á–∞: –°–Ω—è—Ç—å —Å–æ–º–Ω–µ–Ω–∏—è –∏ –ø–æ–∫–∞–∑–∞—Ç—å —Ü–µ–Ω–Ω–æ—Å—Ç—å.\nSPIN-—Ñ–∞–∑–∞: Implication ‚Äî —É—Å–∏–ª—å –±–æ–ª—å –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è (\"–°–∫–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤—ã —Ç–µ—Ä—è–µ—Ç–µ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –±–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è?\").\n–¢–æ–Ω: –£–≤–µ—Ä–µ–Ω–Ω—ã–π, —Å —Å–æ—Ü–∏–∞–ª—å–Ω—ã–º–∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞–º–∏.\n–¶–µ–ª—å –≤–æ–ø—Ä–æ—Å–∞: –ü–æ–¥–≤–µ—Å—Ç–∏ –∫ –æ—Å–æ–∑–Ω–∞–Ω–∏—é —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è.\n–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: calculate_roi, compare_plans, check_discount.\n–ú–∏–∫—Ä–æ-–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ: \"–î–∞–≤–∞–π—Ç–µ –ø–æ–∫–∞–∂—É, –∫–∞–∫ —ç—Ç–æ —Ä–µ—à–∞–µ—Ç—Å—è –∑–∞ 10 –¥–Ω–µ–π?\"\n–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è: \"–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ: —á–µ—Ä–µ–∑ 2 –Ω–µ–¥–µ–ª–∏ –≤–∞—à–∏ –∫–ª–∏–µ–Ω—Ç—ã –∑–∞–∫–∞–∑—ã–≤–∞—é—Ç –ø—Ä—è–º–æ –≤ Telegram.\""
    },
    "decision": {
        "keywords": [
            "–∑–∞–∫–∞–∑", "–æ—Ñ–æ—Ä–º–∏—Ç—å", "–¥–∞–≤–∞–π—Ç–µ", "–Ω–∞—á–∏–Ω–∞–µ–º", "–¥–æ–≥–æ–≤–æ—Ä",
            "–∫–æ–Ω—Ç—Ä–∞–∫—Ç", "–∫–æ–≥–¥–∞ –Ω–∞—á–Ω—ë–º", "–≥–æ—Ç–æ–≤", "—Ö–æ—á—É –∑–∞–∫–∞–∑–∞—Ç—å",
            "–∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è", "—Å–æ–∑–≤–æ–Ω", "let's start",
            "–±—Ä–∏—Ñ", "–¢–ó", "—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ"
        ],
        "max_messages": 999,
        "instruction": "–°–¢–ê–î–ò–Ø: –†–ï–®–ï–ù–ò–ï (Decision)\n–ó–∞–¥–∞—á–∞: –ó–∞–∫—Ä—ã—Ç—å —Å–¥–µ–ª–∫—É, –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏.\nSPIN-—Ñ–∞–∑–∞: Need-Payoff ‚Äî –∫–ª–∏–µ–Ω—Ç —Å–∞–º –≤–∏–¥–∏—Ç —Ü–µ–Ω–Ω–æ—Å—Ç—å (\"–ö–∞–∫ –∏–∑–º–µ–Ω—è—Ç—Å—è –≤–∞—à–∏ –ø—Ä–æ–¥–∞–∂–∏ —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º?\").\n–¢–æ–Ω: –î–µ–ª–æ–≤–æ–π, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤.\n–¶–µ–ª—å –≤–æ–ø—Ä–æ—Å–∞: –ü–æ–ª—É—á–∏—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —à–∞–≥.\n–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: generate_brief, schedule_consultation, create_lead.\n–ú–∏–∫—Ä–æ-–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ: \"–ö–æ–≥–¥–∞ —É–¥–æ–±–Ω–æ –æ–±—Å—É–¥–∏—Ç—å –¥–µ—Ç–∞–ª–∏ ‚Äî —Å–µ–≥–æ–¥–Ω—è –∏–ª–∏ –∑–∞–≤—Ç—Ä–∞?\""
    },
    "action": {
        "keywords": [
            "–æ–ø–ª–∞—Ç", "–æ–ø–ª–∞—á—É", "—Ä–µ–∫–≤–∏–∑–∏—Ç—ã", "–ø–µ—Ä–µ–≤–æ–¥", "–∫–∞—Ä—Ç–∞",
            "—Å—á—ë—Ç", "invoice", "pay", "payment", "—Ä–∞—Å—Å—Ä–æ—á–∫–∞"
        ],
        "max_messages": 999,
        "instruction": "–°–¢–ê–î–ò–Ø: –û–ü–õ–ê–¢–ê (Action)\n–ó–∞–¥–∞—á–∞: –£–ø—Ä–æ—Å—Ç–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã.\n–¢–æ–Ω: –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π, —á—ë—Ç–∫–∏–π.\n–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: show_payment_info.\n–ù–∞–ø–æ–º–Ω–∏: —Ä–∞—Å—Å—Ä–æ—á–∫–∞ 35%+65%, –¥–æ–≥–æ–≤–æ—Ä –¥–æ –æ–ø–ª–∞—Ç—ã.\n–£–±–µ—Ä–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–º–Ω–µ–Ω–∏—è: \"14 –¥–Ω–µ–π –ø—Ä–∞–≤–æ–∫ –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –≥–∞—Ä–∞–Ω—Ç–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã.\""
    }
}


MOMENTUM_PATTERNS = {
    "low_engagement": [
        "–æ–∫", "ok", "—É–≥—É", "–∞–≥–∞", "–¥–∞", "–Ω–µ—Ç", "–ø–æ–Ω—è–ª", "—è—Å–Ω–æ",
        "—Ö–æ—Ä–æ—à–æ", "–ª–∞–¥–Ω–æ", "–º–º", "–Ω—É", "fine", "sure", "yeah"
    ],
    "topic_drift": [
        "–∞ –∫—Å—Ç–∞—Ç–∏", "–≤–æ–æ–±—â–µ", "by the way", "–∫—Å—Ç–∞—Ç–∏",
        "–Ω–µ —Å–≤—è–∑–∞–Ω–æ", "–¥—Ä—É–≥–æ–π –≤–æ–ø—Ä–æ—Å", "–∞ –µ—â—ë"
    ]
}

MOMENTUM_STRATEGIES = {
    "low_engagement": "MOMENTUM –ù–ò–ó–ö–ò–ô: –ö–ª–∏–µ–Ω—Ç –¥–∞—ë—Ç –∫–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã ‚Äî —Ç–µ—Ä—è–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å. –°–º–µ–Ω–∏ —Ç–∞–∫—Ç–∏–∫—É:\n‚Ä¢ –ó–∞–¥–∞–π –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å (\"–ê –≤—ã –∑–Ω–∞–ª–∏, —á—Ç–æ 70% –∫–ª–∏–µ–Ω—Ç–æ–≤ —É—Ö–æ–¥—è—Ç –∫ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º –∏–∑-–∑–∞ –Ω–µ—É–¥–æ–±–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞?\")\n‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç (\"–°–µ–π—á–∞—Å vs —á–µ—Ä–µ–∑ 10 –¥–Ω–µ–π —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º\")\n‚Ä¢ –ü—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–∏–∑—É–∞–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä\n‚Ä¢ –ò–ª–∏ –ø—Ä—è–º–æ —Å–ø—Ä–æ—Å–∏: \"–ß—Ç–æ –¥–ª—è –≤–∞—Å —Å–µ–π—á–∞—Å —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ?\"",
    "topic_drift": "MOMENTUM –î–†–ï–ô–§: –ö–ª–∏–µ–Ω—Ç —É—Ö–æ–¥–∏—Ç –æ—Ç —Ç–µ–º—ã. –ú—è–≥–∫–æ –≤–µ—Ä–Ω–∏:\n‚Ä¢ –û—Ç–≤–µ—Ç—å –∫—Ä–∞—Ç–∫–æ –Ω–∞ –æ—Ç–≤–ª–µ—á—ë–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å\n‚Ä¢ –°–≤—è–∂–∏ –µ–≥–æ —Å –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–º–æ–π\n‚Ä¢ \"–ö—Å—Ç–∞—Ç–∏, –≤–æ–∑–≤—Ä–∞—â–∞—è—Å—å –∫ –≤–∞—à–µ–º—É –ø—Ä–æ–µ–∫—Ç—É...\""
}


DYNAMIC_BUTTONS_BY_STAGE = {
    "awareness": [
        ("üí∞ –£–∑–Ω–∞—Ç—å —Ü–µ–Ω—ã", "smart_prices"),
        ("üìÇ –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç", "smart_portfolio"),
        ("‚ùì –ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã", "smart_faq")
    ],
    "interest": [
        ("üßÆ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å", "smart_calc"),
        ("üìÇ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∏–º–µ—Ä—ã", "smart_portfolio"),
        ("üìä –°—Ä–∞–≤–Ω–∏—Ç—å –ø–∞–∫–µ—Ç—ã", "smart_compare")
    ],
    "consideration": [
        ("üìä –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å", "smart_roi"),
        ("üéÅ –£–∑–Ω–∞—Ç—å –ø—Ä–æ —Å–∫–∏–¥–∫–∏", "smart_discount"),
        ("üìû –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è", "smart_consult")
    ],
    "decision": [
        ("üìã –°–æ—Å—Ç–∞–≤–∏—Ç—å –¢–ó", "smart_brief"),
        ("üìû –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–æ–∑–≤–æ–Ω", "smart_consult"),
        ("‚úÖ –û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É", "smart_lead")
    ],
    "action": [
        ("üí≥ –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã", "smart_payment"),
        ("üìÑ –°–∫–∞—á–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä", "smart_contract"),
        ("üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º", "smart_manager")
    ]
}


def detect_emotions(text: str) -> list:
    text_lower = text.lower()
    detected = []
    for emotion, patterns in EMOTION_PATTERNS.items():
        for pattern in patterns:
            if pattern in text_lower:
                detected.append(emotion)
                break
    return detected


def detect_objections(text: str) -> list:
    text_lower = text.lower()
    detected = []
    for obj_type, patterns in OBJECTION_PATTERNS.items():
        for pattern in patterns:
            if pattern in text_lower:
                detected.append(obj_type)
                break
    return detected


def detect_momentum(text: str) -> Optional[str]:
    text_lower = text.strip().lower()
    if len(text_lower) <= 15:
        for pattern in MOMENTUM_PATTERNS["low_engagement"]:
            if text_lower == pattern or text_lower.rstrip(".!,") == pattern:
                return "low_engagement"
    for pattern in MOMENTUM_PATTERNS["topic_drift"]:
        if pattern in text_lower:
            return "topic_drift"
    return None


SEMANTIC_INTENT_PATTERNS = {
    "action": [
        "—Ö–æ—á—É –æ–ø–ª–∞—Ç–∏—Ç—å", "–≥–æ—Ç–æ–≤ –æ–ø–ª–∞—Ç–∏—Ç—å", "–≤—ã—Å—Ç–∞–≤—å—Ç–µ —Å—á—ë—Ç", "–∫—É–¥–∞ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å",
        "–∫–∞–∫ –æ–ø–ª–∞—Ç–∏—Ç—å", "–¥–∞–≤–∞–π—Ç–µ –∫ –æ–ø–ª–∞—Ç–µ", "–æ–ø–ª–∞—á—É —Å–µ–≥–æ–¥–Ω—è", "–ø—Ä–∏—Å—ã–ª–∞–π—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã",
        "—Ö–æ—á—É –∫—É–ø–∏—Ç—å", "–±–µ—Ä—É", "–æ—Ñ–æ—Ä–º–ª—è—é"
    ],
    "decision": [
        "–¥–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω—ë–º", "—Ö–æ—á—É –∑–∞–∫–∞–∑–∞—Ç—å", "–≥–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å", "–º–Ω–µ –Ω—É–∂–Ω–æ —ç—Ç–æ",
        "–∫–æ–≥–¥–∞ —Å–º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å", "—Å–¥–µ–ª–∞–π—Ç–µ –º–Ω–µ", "—è —Ä–µ—à–∏–ª", "–±–µ—Ä—ë–º",
        "–Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å", "—Ö–æ—á—É —Ç–∞–∫–æ–µ –∂–µ", "–º–Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç", "–∑–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ",
        "–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑—ã", "–Ω—É–∂–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", "—Ö–æ—á—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ",
        "–Ω—É–∂–µ–Ω –±–æ—Ç", "—Å–¥–µ–ª–∞–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", "–∑–∞–∫–∞–∂—É",
        "–Ω—É–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å", "—Ö–æ—á—É –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å",
        "–Ω—É–∂–Ω–∞ –∑–∞–ø–∏—Å—å –æ–Ω–ª–∞–π–Ω", "—Ö–æ—á—É –æ–Ω–ª–∞–π–Ω-–º–∞–≥–∞–∑–∏–Ω",
        "—Ö–æ—á—É –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞–∫–∞–∑—ã", "–Ω—É–∂–µ–Ω –∫–∞—Ç–∞–ª–æ–≥",
        "–ø–æ–¥–∫–ª—é—á–∏—Ç—å –æ–ø–ª–∞—Ç—É", "–Ω—É–∂–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏"
    ],
    "consideration": [
        "–∞ –µ—Å–ª–∏ —Å—Ä–∞–≤–Ω–∏—Ç—å", "–∫–∞–∫–∏–µ –≥–∞—Ä–∞–Ω—Ç–∏–∏", "–∞ –≤–¥—Ä—É–≥ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è",
        "—Å—Ç–æ–∏—Ç –ª–∏", "–æ–∫—É–ø–∏—Ç—Å—è –ª–∏", "–∏–º–µ–µ—Ç –ª–∏ —Å–º—ã—Å–ª", "–Ω–µ —É–≤–µ—Ä–µ–Ω —á—Ç–æ –Ω—É–∂–Ω–æ",
        "–∞ —á—Ç–æ –µ—Å–ª–∏", "—á–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è", "–∫–∞–∫–∞—è —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É",
        "–º–æ–∂–µ—Ç –ø–æ–¥–æ–∂–¥–∞—Ç—å", "–Ω–∞–¥–æ –ø–æ–¥—É–º–∞—Ç—å", "–ø–æ—Å–æ–≤–µ—Ç—É—é—Å—å",
        "–∞ —á—Ç–æ –±—É–¥–µ—Ç –µ—Å–ª–∏", "–Ω–∞—Å–∫–æ–ª—å–∫–æ –Ω–∞–¥—ë–∂–Ω–æ", "–∞ –≤—ã —Ç–æ—á–Ω–æ —Å–¥–µ–ª–∞–µ—Ç–µ",
        "–∞ –µ—Å—Ç—å –æ—Ç–∑—ã–≤—ã", "–ø–æ–∫–∞–∂–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã", "–¥–æ–ª–≥–æ –ª–∏ –¥–µ–ª–∞—Ç—å"
    ],
    "interest": [
        "—Å–∫–æ–ª—å–∫–æ —ç—Ç–æ —Å—Ç–æ–∏—Ç", "–∫–∞–∫–∏–µ —Ü–µ–Ω—ã", "–∫–∞–∫–∏–µ —Å—Ä–æ–∫–∏", "—á—Ç–æ –≤—Ö–æ–¥–∏—Ç",
        "—Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ", "–∫–∞–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏", "—á—Ç–æ —É–º–µ–µ—Ç",
        "–º–æ–∂–Ω–æ –ª–∏ —Å–¥–µ–ª–∞—Ç—å", "–µ—Å—Ç—å –ø—Ä–∏–º–µ—Ä—ã", "–ø–æ–∫–∞–∂–∏—Ç–µ —Ä–∞–±–æ—Ç—ã",
        "–∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç", "–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ —É–∑–Ω–∞—Ç—å", "–∞ –º–æ–∂–Ω–æ", "–∞ –µ—Å—Ç—å",
        "–∏–∑ —á–µ–≥–æ —Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è —Ü–µ–Ω–∞", "—á—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ –≤ —Å—Ç–æ–∏–º–æ—Å—Ç—å",
        "–∫–∞–∫–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –µ—Å—Ç—å", "–∞ –º–æ–∂–Ω–æ –¥–µ—à–µ–≤–ª–µ", "–µ—Å—Ç—å —Ä–∞—Å—Å—Ä–æ—á–∫–∞"
    ]
}

BACKSLIDE_PATTERNS = [
    "–ø–æ–¥—É–º–∞—é", "–Ω–µ —É–≤–µ—Ä–µ–Ω", "–¥–æ—Ä–æ–≥–æ", "–ø–æ–∑–∂–µ", "–Ω–µ —Å–µ–π—á–∞—Å",
    "—Å–æ–º–Ω–µ–≤–∞—é—Å—å", "–Ω–µ –≥–æ—Ç–æ–≤", "—Ä–∞–Ω–æ –µ—â—ë", "–¥—Ä—É–≥–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã",
    "–Ω—É–∂–Ω–æ –ø–æ—Å–æ–≤–µ—Ç–æ–≤–∞—Ç—å—Å—è", "–Ω–µ –∑–Ω–∞—é –Ω—É–∂–Ω–æ –ª–∏", "–ø–æ–∫–∞ –Ω–µ –Ω–∞–¥–æ",
    "–ø–µ—Ä–µ–¥—É–º–∞–ª", "–æ—Ç–ª–æ–∂–∏–º", "–Ω–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ", "–ø–æ–∫–∞ –Ω–µ—Ç",
    "–Ω—É–∂–Ω–æ –æ–±—Å—É–¥–∏—Ç—å —Å –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º", "–ø–æ—Å–æ–≤–µ—Ç—É—é—Å—å —Å –∫–æ–º–∞–Ω–¥–æ–π",
    "–º–æ–∂–µ—Ç –ø–æ—Ç–æ–º", "–Ω–µ —Å–µ–≥–æ–¥–Ω—è", "–≤–µ—Ä–Ω—É—Å—å –ø–æ–∑–∂–µ"
]


def detect_funnel_stage(user_id: int, user_message: str, message_count: int = 0) -> str:
    text_lower = user_message.lower()

    lead_score = 0
    lead_actions = set()
    lead_tags = set()
    try:
        from src.leads import lead_manager
        lead = lead_manager.get_lead(user_id)
        if lead:
            lead_score = lead.score or 0
            if lead.tags:
                lead_tags = set(lead.tags)
            events = lead_manager.get_events(user_id) if hasattr(lead_manager, 'get_events') else []
            for ev in events:
                event_type = ev.get("event_type", "") if isinstance(ev, dict) else ""
                lead_actions.add(event_type)
    except Exception:
        pass

    has_backslide = any(bp in text_lower for bp in BACKSLIDE_PATTERNS)

    keyword_stage = _keyword_stage(text_lower, lead_actions, message_count)
    semantic_stage = _semantic_stage(text_lower)
    score_stage = _score_stage(lead_score)

    stage_priority = {"awareness": 0, "interest": 1, "consideration": 2, "decision": 3, "action": 4}

    candidates = [keyword_stage, semantic_stage, score_stage]
    best = max(candidates, key=lambda s: stage_priority.get(s, 0))

    if has_backslide and stage_priority.get(best, 0) >= 3:
        best = "consideration"
    elif has_backslide and stage_priority.get(best, 0) >= 2:
        best = "interest"

    if "ready_to_buy" in lead_tags and not has_backslide:
        if stage_priority.get(best, 0) < 3:
            best = "decision"

    return best


def _keyword_stage(text_lower: str, lead_actions: set, message_count: int) -> str:
    if any(kw in text_lower for kw in FUNNEL_STAGE_SIGNALS["action"]["keywords"]):
        return "action"
    if any(kw in text_lower for kw in FUNNEL_STAGE_SIGNALS["decision"]["keywords"]):
        return "decision"
    if any("payment" in a or "lead" in a or "contact" in a for a in lead_actions):
        return "decision"
    if any(kw in text_lower for kw in FUNNEL_STAGE_SIGNALS["consideration"]["keywords"]):
        return "consideration"
    if any("calc" in a or "portfolio" in a or "price" in a for a in lead_actions):
        return "consideration"
    if any(kw in text_lower for kw in FUNNEL_STAGE_SIGNALS["interest"]["keywords"]):
        return "interest"
    if message_count > FUNNEL_STAGE_SIGNALS["awareness"]["max_messages"]:
        return "interest"
    return "awareness"


def _semantic_stage(text_lower: str) -> str:
    for stage in ["action", "decision", "consideration", "interest"]:
        patterns = SEMANTIC_INTENT_PATTERNS.get(stage, [])
        matches = sum(1 for p in patterns if p in text_lower)
        if matches >= 1:
            return stage
    return "awareness"


def _score_stage(lead_score: int) -> str:
    if lead_score >= 60:
        return "action"
    if lead_score >= 40:
        return "decision"
    if lead_score >= 20:
        return "consideration"
    if lead_score >= 5:
        return "interest"
    return "awareness"


def detect_client_style(user_message: str, message_count: int = 0) -> Optional[str]:
    text = user_message.strip()
    word_count = len(text.split())

    if word_count <= 5 and message_count > 2:
        return "–°–¢–ò–õ–¨: –õ–∞–∫–æ–Ω–∏—á–Ω—ã–π. –ö–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –∫–æ—Ä–æ—Ç–∫–æ ‚Äî –æ—Ç–≤–µ—á–∞–π —Ç–∞–∫ –∂–µ: 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —Å—É—Ç—å –±–µ–∑ –≤–æ–¥—ã. –ù–µ –∑–∞–¥–∞–≤–∞–π –ª–∏—à–Ω–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤."

    if word_count >= 50:
        return "–°–¢–ò–õ–¨: –†–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–π. –ö–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–æ ‚Äî –º–æ–∂–µ—à—å –¥–∞—Ç—å –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (–¥–æ 150 —Å–ª–æ–≤). –ü–æ–∫–∞–∂–∏, —á—Ç–æ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–ª."

    has_formal = any(w in text.lower() for w in ["—É–≤–∞–∂–∞–µ–º—ã–π", "–ø—Ä–æ—à—É", "–±—É–¥—å—Ç–µ –¥–æ–±—Ä—ã", "–Ω–µ –º–æ–≥–ª–∏ –±—ã", "—Å–æ–±–ª–∞–≥–æ–≤–æ–ª–∏—Ç–µ"])
    if has_formal:
        return "–°–¢–ò–õ–¨: –§–æ—Ä–º–∞–ª—å–Ω—ã–π. –ö–ª–∏–µ–Ω—Ç –æ–±—â–∞–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ ‚Äî –±—É–¥—å –≤–µ–∂–ª–∏–≤–µ–µ, –Ω–∞ \"–≤—ã\", –±–µ–∑ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã—Ö –æ–±–æ—Ä–æ—Ç–æ–≤ –∏ )."

    has_casual = any(w in text.lower() for w in ["—á—ë", "–≤–∞—â–µ", "–Ω–æ—Ä–º", "–æ–∫", "–≥–æ", "—Ö–∑", "–∫—Å—Ç–∞", "—á–µ–ª", "—Ç–∏–ø"])
    if has_casual:
        return "–°–¢–ò–õ–¨: –ù–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π. –ö–ª–∏–µ–Ω—Ç –æ–±—â–∞–µ—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω–æ ‚Äî –±—É–¥—å –ø—Ä–æ—â–µ, –∏—Å–ø–æ–ª—å–∑—É–π ), –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–Ω—ã–π —Å—Ç–∏–ª—å."

    return None


PROACTIVE_VALUE_BY_INDUSTRY = {
    "shop": "–¶–ï–ù–ù–û–°–¢–¨: –î–ª—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–æ–≤ ‚Äî —Å—Ä–µ–¥–Ω–∏–π —Ä–æ—Å—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ Mini App —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 35-45%, –ø–æ—Ç–æ–º—É —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –Ω–µ —É—Ö–æ–¥–∏—Ç –∏–∑ Telegram. –ü—Ä–µ–¥–ª–æ–∂–∏: \"–•–æ—Ç–∏—Ç–µ, –ø—Ä–∏–∫–∏–Ω—É —Å–∫–æ–ª—å–∫–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ —ç—Ç–æ –¥–∞—Å—Ç –ø—Ä–∏ –≤–∞—à–µ–º —Ç—Ä–∞—Ñ–∏–∫–µ?\"",
    "restaurant": "–¶–ï–ù–ù–û–°–¢–¨: –î–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ ‚Äî Mini App —É–±–∏—Ä–∞–µ—Ç –∫–æ–º–∏—Å—Å–∏—é –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–æ–≤ (15-30%). –ü—Ä–∏ 100 –∑–∞–∫–∞–∑–∞—Ö/–º–µ—Å –ø–æ 1500‚ÇΩ —ç–∫–æ–Ω–æ–º–∏—è = 22-45–∫/–º–µ—Å. –ü—Ä–µ–¥–ª–æ–∂–∏: \"–î–∞–≤–∞–π—Ç–µ –ø–æ—Å—á–∏—Ç–∞—é, —Å–∫–æ–ª—å–∫–æ –≤—ã –æ—Ç–¥–∞—ë—Ç–µ –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–∞–º ‚Äî —Ü–∏—Ñ—Ä—ã –æ–±—ã—á–Ω–æ —É–¥–∏–≤–ª—è—é—Ç\"",
    "beauty": "–¶–ï–ù–ù–û–°–¢–¨: –î–ª—è —Å–∞–ª–æ–Ω–æ–≤ –∫—Ä–∞—Å–æ—Ç—ã ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ Mini App —Å–æ–∫—Ä–∞—â–∞–µ—Ç no-show –Ω–∞ 40% (–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ Telegram). –ü—Ä–µ–¥–ª–æ–∂–∏: \"–ó–Ω–∞–µ—Ç–µ, —Å–∫–æ–ª—å–∫–æ –¥–µ–Ω–µ–≥ —Ç–µ—Ä—è–µ—Ç—Å—è –Ω–∞ –æ—Ç–º–µ–Ω–∞—Ö –∏ –Ω–µ—è–≤–∫–∞—Ö? –ú–æ–≥—É –ø—Ä–∏–∫–∏–Ω—É—Ç—å.\"",
    "fitness": "–¶–ï–ù–ù–û–°–¢–¨: –î–ª—è —Ñ–∏—Ç–Ω–µ—Å–∞ ‚Äî —Ç—Ä–µ–∫–∏–Ω–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ 60% –¥–æ–ª—å—à–µ (LTV —Ä–∞—Å—Ç—ë—Ç). –ü—Ä–µ–¥–ª–æ–∂–∏: \"–•–æ—Ç–∏—Ç–µ, –ø–æ–∫–∞–∂—É –∫–∞–∫ –¥—Ä—É–≥–∏–µ –∫–ª—É–±—ã —É–≤–µ–ª–∏—á–∏–ª–∏ retention?\"",
    "medical": "–¶–ï–ù–ù–û–°–¢–¨: –î–ª—è –∫–ª–∏–Ω–∏–∫ ‚Äî –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ Telegram —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∑–∞–ø–æ–ª–Ω—è–µ–º–æ—Å—Ç—å –Ω–∞ 25%. –£–¥–æ–±—Å—Ç–≤–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞ = –ª–æ—è–ª—å–Ω–æ—Å—Ç—å. –ü—Ä–µ–¥–ª–æ–∂–∏: \"–î–∞–≤–∞–π—Ç–µ –ø—Ä–∏–∫–∏–Ω–µ–º, —Å–∫–æ–ª—å–∫–æ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ –≤—ã —Ç–µ—Ä—è–µ—Ç–µ –∏–∑-–∑–∞ –Ω–µ—É–¥–æ–±–Ω–æ–π –∑–∞–ø–∏—Å–∏?\"",
    "ai": "–¶–ï–ù–ù–û–°–¢–¨: AI-–±–æ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç 70-80% —Ç–∏–ø–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –±–µ–∑ —É—á–∞—Å—Ç–∏—è —á–µ–ª–æ–≤–µ–∫–∞, 24/7. –≠–∫–æ–Ω–æ–º–∏—è –Ω–∞ 1 —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ = 80-120–∫/–º–µ—Å. –ü—Ä–µ–¥–ª–æ–∂–∏: \"–ú–æ–≥—É –ø–æ–∫–∞–∑–∞—Ç—å –¥–µ–º–æ AI-–±–æ—Ç–∞ –∏–∑ –ø–æ—Ö–æ–∂–µ–π –Ω–∏—à–∏\"",
    "services": "–¶–ï–ù–ù–û–°–¢–¨: –î–ª—è —Å–µ—Ä–≤–∏—Å–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π ‚Äî –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ Mini App —É–±–∏—Ä–∞–µ—Ç 60% –∑–≤–æ–Ω–∫–æ–≤. –ö–ª–∏–µ–Ω—Ç—ã –±—Ä–æ–Ω–∏—Ä—É—é—Ç —Å–∞–º–∏ 24/7, –≤—ã –Ω–µ —Ç–µ—Ä—è–µ—Ç–µ –∑–∞–∫–∞–∑—ã –≤ –Ω–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è. –ü—Ä–µ–¥–ª–æ–∂–∏: \"–î–∞–≤–∞–π—Ç–µ –ø—Ä–∏–∫–∏–Ω–µ–º, —Å–∫–æ–ª—å–∫–æ –∑–∞–∫–∞–∑–æ–≤ –≤—ã —Ç–µ—Ä—è–µ—Ç–µ –∏–∑-–∑–∞ –∑–∞–Ω—è—Ç–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞?\"",
    "education": "–¶–ï–ù–ù–û–°–¢–¨: –î–ª—è –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è ‚Äî Mini App —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏ –ø–æ–≤—ã—à–∞–µ—Ç –¥–æ—Ö–æ–¥–∏–º–æ—Å—Ç—å –Ω–∞ 40-55%. –û–ø–ª–∞—Ç–∞ –ø—Ä—è–º–æ –≤ Telegram –±–µ–∑ —É—Ö–æ–¥–∞ –Ω–∞ —Å–∞–π—Ç. –ü—Ä–µ–¥–ª–æ–∂–∏: \"–•–æ—Ç–∏—Ç–µ, –ø–æ–∫–∞–∂—É –∫–∞–∫ –¥—Ä—É–≥–∏–µ —à–∫–æ–ª—ã —É–≤–µ–ª–∏—á–∏–ª–∏ –¥–æ—Ö–æ–¥–∏–º–æ—Å—Ç—å?\"",
    "delivery": "–¶–ï–ù–ù–û–°–¢–¨: –î–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ ‚Äî —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π Mini App –≤–º–µ—Å—Ç–æ –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–∞ —ç–∫–æ–Ω–æ–º–∏—Ç 15-30% –∫–æ–º–∏—Å—Å–∏–π. –ü—Ä–∏ 200 –∑–∞–∫–∞–∑–∞—Ö/–º–µ—Å —ç–∫–æ–Ω–æ–º–∏—è = 45-90–∫/–º–µ—Å. –ü—Ä–µ–¥–ª–æ–∂–∏: \"–î–∞–≤–∞–π—Ç–µ –ø–æ—Å—á–∏—Ç–∞—é, —Å–∫–æ–ª—å–∫–æ –≤—ã –æ—Ç–¥–∞—ë—Ç–µ –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–∞–º ‚Äî —Ü–∏—Ñ—Ä—ã –æ–±—ã—á–Ω–æ —É–¥–∏–≤–ª—è—é—Ç\"",
}

PROACTIVE_VALUE_BY_STAGE = {
    "awareness": "–ü–æ–¥–≥–æ—Ç–æ–≤–∏–ª –¥–ª—è –≤–∞—Å –º–∏–Ω–∏-—á–µ–∫-–ª–∏—Å—Ç \"5 –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º Mini App\" ‚Äî –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–Ω—è—Ç—å —á—Ç–æ –Ω—É–∂–Ω–æ. –ü–æ–∫–∞–∑–∞—Ç—å?",
    "interest": "–£ –Ω–∞—Å –µ—Å—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ä–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ ‚Äî —É–∫–∞–∑—ã–≤–∞–µ—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏, –ø–æ–ª—É—á–∞–µ—Ç–µ —Ç–æ—á–Ω—É—é —Ü–∏—Ñ—Ä—É. –•–æ—Ç–∏—Ç–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å?",
    "consideration": "–ú–æ–≥—É –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –¥–ª—è –≤–∞—Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ: –≤–∞—à–∏ –∑–∞—Ç—Ä–∞—Ç—ã —Å–µ–π—á–∞—Å vs. —Å Mini App. –≠—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ –∏ –Ω–∏ –∫ —á–µ–º—É –Ω–µ –æ–±—è–∑—ã–≤–∞–µ—Ç.",
    "decision": "–ú–æ–≥—É –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –Ω–∞–±—Ä–æ—Å–∞—Ç—å –¥–ª—è –≤–∞—Å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –¢–ó ‚Äî —ç—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ –∏ –¥–∞—Å—Ç –ø–æ–Ω–∏–º–∞–Ω–∏–µ –≤—Å–µ–≥–æ –æ–±—ä—ë–º–∞ —Ä–∞–±–æ—Ç.",
}


def get_proactive_value(user_id: int, funnel_stage: str) -> str:
    try:
        from src.leads import lead_manager
        lead = lead_manager.get_lead(user_id)
        if lead and lead.tags:
            for tag in lead.tags:
                if tag in PROACTIVE_VALUE_BY_INDUSTRY:
                    return f"[–ü–†–û–ê–ö–¢–ò–í–ù–ê–Ø –¶–ï–ù–ù–û–°–¢–¨]\n{PROACTIVE_VALUE_BY_INDUSTRY[tag]}"
    except Exception:
        pass

    if funnel_stage in PROACTIVE_VALUE_BY_STAGE:
        return f"[–ü–†–û–ê–ö–¢–ò–í–ù–ê–Ø –¶–ï–ù–ù–û–°–¢–¨]\n{PROACTIVE_VALUE_BY_STAGE[funnel_stage]}"
    return ""


INDUSTRY_CASE_STUDIES = {
    "shop": {
        "name": "Radiance",
        "desc": "–º–∞–≥–∞–∑–∏–Ω –ø—Ä–µ–º–∏—É–º-–æ–¥–µ–∂–¥—ã",
        "result": "200+ –∑–∞–∫–∞–∑–æ–≤ –≤ –ø–µ—Ä–≤—É—é –Ω–µ–¥–µ–ª—é, –∫–æ–Ω–≤–µ—Ä—Å–∏—è –∏–∑ Telegram –≤ –ø–æ–∫—É–ø–∫—É ‚Äî 12%",
        "quote": "–ñ–∞–ª–µ—é —á—Ç–æ –Ω–µ —Å–¥–µ–ª–∞–ª —Ä–∞–Ω—å—à–µ ‚Äî –∑–∞ –º–µ—Å—è—Ü –æ–∫—É–ø–∏–ª–æ—Å—å –¥–≤–∞–∂–¥—ã"
    },
    "restaurant": {
        "name": "DeluxeDine",
        "desc": "—Ä–µ—Å—Ç–æ—Ä–∞–Ω —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π",
        "result": "–ø–µ—Ä–µ—à–ª–∏ —Å –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–∞, —ç–∫–æ–Ω–æ–º–∏—è 35–∫/–º–µ—Å –Ω–∞ –∫–æ–º–∏—Å—Å–∏—è—Ö, +47 –∑–∞–∫–∞–∑–æ–≤ –≤ –ø–µ—Ä–≤—ã–π –º–µ—Å—è—Ü",
        "quote": "–ê–≥—Ä–µ–≥–∞—Ç–æ—Ä—ã –∑–∞–±–∏—Ä–∞–ª–∏ 25% ‚Äî —Ç–µ–ø–µ—Ä—å –≤—Å—è –º–∞—Ä–∂–∞ –Ω–∞—à–∞"
    },
    "beauty": {
        "name": "GlowSpa",
        "desc": "—Å–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã",
        "result": "no-show —Å–Ω–∏–∑–∏–ª—Å—è –Ω–∞ 45%, –∑–∞–≥—Ä—É–∑–∫–∞ –º–∞—Å—Ç–µ—Ä–æ–≤ –≤—ã—Ä–æ—Å–ª–∞ –¥–æ 90%",
        "quote": "–ö–ª–∏–µ–Ω—Ç—ã —Ç–µ–ø–µ—Ä—å –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Å–∞–º–∏, –¥–∞–∂–µ –Ω–æ—á—å—é"
    },
    "fitness": {
        "name": "FitPro",
        "desc": "—Ñ–∏—Ç–Ω–µ—Å-–∫–ª—É–±",
        "result": "retention –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤—ã—Ä–æ—Å –Ω–∞ 35%, –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã —Å—Ç–∞–ª–∏ –ø—Ä–æ–¥–ª–µ–≤–∞—Ç—å —á–∞—â–µ",
        "quote": "–¢—Ä–µ–∫–∏–Ω–≥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ ‚Äî –≥–ª–∞–≤–Ω–∞—è —Ñ–∏—à–∫–∞, –ª—é–¥–∏ –ø—Ä–∏–≤—ã–∫–∞—é—Ç"
    },
    "medical": {
        "name": "MedLine",
        "desc": "–º–Ω–æ–≥–æ–ø—Ä–æ—Ñ–∏–ª—å–Ω–∞—è –∫–ª–∏–Ω–∏–∫–∞",
        "result": "–∑–∞–ø–æ–ª–Ω—è–µ–º–æ—Å—Ç—å —Å–ª–æ—Ç–æ–≤ –≤—ã—Ä–æ—Å–ª–∞ –Ω–∞ 30%, no-show —Å–Ω–∏–∑–∏–ª—Å—è –Ω–∞ 50%",
        "quote": "–ü–∞—Ü–∏–µ–Ω—Ç—ã –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Å–∞–º–∏ —á–µ—Ä–µ–∑ Telegram ‚Äî –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –Ω–∞–∫–æ–Ω–µ—Ü —Å–≤–æ–±–æ–¥–Ω—ã"
    },
    "services": {
        "name": "CleanPro",
        "desc": "–∫–ª–∏–Ω–∏–Ω–≥–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å",
        "result": "–∫–æ–Ω–≤–µ—Ä—Å–∏—è –∏–∑ –∑–∞—è–≤–∫–∏ –≤ –∑–∞–∫–∞–∑ –≤—ã—Ä–æ—Å–ª–∞ –Ω–∞ 40%, –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–∫–∞–∑—ã +25%",
        "quote": "–ö–ª–∏–µ–Ω—Ç—ã –∑–∞–∫–∞–∑—ã–≤–∞—é—Ç —É–±–æ—Ä–∫—É –≤ –¥–≤–∞ –∫–ª–∏–∫–∞, –±–µ–∑ –∑–≤–æ–Ω–∫–æ–≤"
    },
    "education": {
        "name": "SkillUp",
        "desc": "–æ–Ω–ª–∞–π–Ω-—à–∫–æ–ª–∞",
        "result": "–¥–æ—Ö–æ–¥–∏–º–æ—Å—Ç—å –¥–æ –∫–æ–Ω—Ü–∞ –∫—É—Ä—Å–∞ –≤—ã—Ä–æ—Å–ª–∞ –Ω–∞ 55%, —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫ –≤—ã—Ä–æ—Å –Ω–∞ 20%",
        "quote": "–£—á–µ–Ω–∏–∫–∏ –Ω–µ –∑–∞–±—ã–≤–∞—é—Ç –ø—Ä–æ –∑–∞–Ω—è—Ç–∏—è ‚Äî –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø—Ä—è–º–æ –≤ Telegram"
    },
}


def get_relevant_case_study(user_id: int) -> str:
    try:
        from src.leads import lead_manager
        lead = lead_manager.get_lead(user_id)
        if lead and lead.tags:
            for tag in lead.tags:
                if tag in INDUSTRY_CASE_STUDIES:
                    cs = INDUSTRY_CASE_STUDIES[tag]
                    return (
                        f"[–†–ï–õ–ï–í–ê–ù–¢–ù–´–ô –ö–ï–ô–° ‚Äî {cs['name']}]\n"
                        f"–ü—Ä–æ–µ–∫—Ç: {cs['name']} ({cs['desc']})\n"
                        f"–†–µ–∑—É–ª—å—Ç–∞—Ç: {cs['result']}\n"
                        f"–û—Ç–∑—ã–≤ –∫–ª–∏–µ–Ω—Ç–∞: \"{cs['quote']}\""
                    )
    except Exception:
        pass
    return ""


def get_social_proof(objections: list, funnel_stage: str) -> str:
    proofs = []
    for obj in objections:
        if obj in SOCIAL_PROOF_TRIGGERS:
            import random
            proof = random.choice(SOCIAL_PROOF_TRIGGERS[obj])
            proofs.append(proof)

    if not proofs and funnel_stage in ("consideration", "decision"):
        import random
        all_proofs = []
        for v in SOCIAL_PROOF_TRIGGERS.values():
            all_proofs.extend(v)
        if all_proofs:
            proofs.append(random.choice(all_proofs))

    if proofs:
        return "[–°–û–¶–ò–ê–õ–¨–ù–û–ï –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–û ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –≤ –æ—Ç–≤–µ—Ç–µ]\n" + "\n".join(proofs)
    return ""


def build_client_context(user_id: int, username: str = None, first_name: str = None) -> str:
    context_parts = []

    try:
        from src.leads import lead_manager
        lead = lead_manager.get_lead(user_id)
        if lead:
            context_parts.append("[–ü–†–û–§–ò–õ–¨ –ö–õ–ò–ï–ù–¢–ê]")
            context_parts.append(f"–ò–º—è: {lead.first_name or first_name or '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}")
            if lead.score and lead.score > 0:
                context_parts.append(f"–õ–∏–¥-—Å–∫–æ—Ä: {lead.score}/100")
            if lead.priority:
                priority_map = {"cold": "—Ö–æ–ª–æ–¥–Ω—ã–π", "warm": "—Ç—ë–ø–ª—ã–π", "hot": "–≥–æ—Ä—è—á–∏–π", "vip": "VIP"}
                context_parts.append(f"–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {priority_map.get(lead.priority.value, lead.priority.value)}")
            if lead.tags:
                context_parts.append(f"–¢–µ–≥–∏: {', '.join(lead.tags)}")
            if hasattr(lead, 'message_count') and lead.message_count:
                context_parts.append(f"–°–æ–æ–±—â–µ–Ω–∏–π: {lead.message_count}")
    except Exception as e:
        logger.debug(f"Failed to get lead data: {e}")

    try:
        from src.tasks_tracker import tasks_tracker
        progress = tasks_tracker.get_user_progress(user_id)
        if progress and progress.total_coins > 0:
            context_parts.append(f"–ú–æ–Ω–µ—Ç—ã: {progress.total_coins} (—Å–∫–∏–¥–∫–∞ {progress.get_discount_percent()}%)")
    except Exception as e:
        logger.debug(f"Failed to get coins data: {e}")

    try:
        from src.loyalty import loyalty_system
        if loyalty_system.is_returning_customer(user_id):
            context_parts.append("–°—Ç–∞—Ç—É—Å: –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç (+5% —Å–∫–∏–¥–∫–∞)")
        reviews = loyalty_system.get_user_reviews(user_id)
        if reviews:
            context_parts.append(f"–û—Å—Ç–∞–≤–∏–ª {len(reviews)} –æ—Ç–∑—ã–≤–æ–≤")
    except Exception as e:
        logger.debug(f"Failed to get loyalty data: {e}")

    try:
        from src.referrals import referral_system
        referrals = referral_system.get_referrals_list(user_id)
        if referrals:
            context_parts.append(f"–ü—Ä–∏–≤—ë–ª {len(referrals)} —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤")
    except Exception as e:
        logger.debug(f"Failed to get referral data: {e}")

    try:
        from src.leads import lead_manager
        events = lead_manager.get_events(user_id) if hasattr(lead_manager, 'get_events') else []
        if events:
            actions = set()
            for ev in events:
                event_type = ev.get("event_type", "") if isinstance(ev, dict) else ""
                if "calc" in event_type:
                    actions.add("—Å—á–∏—Ç–∞–ª —Å—Ç–æ–∏–º–æ—Å—Ç—å")
                elif "portfolio" in event_type:
                    actions.add("—Å–º–æ—Ç—Ä–µ–ª –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ")
                elif "price" in event_type:
                    actions.add("—Å–º–æ—Ç—Ä–µ–ª —Ü–µ–Ω—ã")
                elif "payment" in event_type:
                    actions.add("–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª—Å—è –æ–ø–ª–∞—Ç–æ–π")
                elif "lead" in event_type or "contact" in event_type:
                    actions.add("–æ—Å—Ç–∞–≤–ª—è–ª –∑–∞—è–≤–∫—É")
            if actions:
                context_parts.append(f"–î–µ–π—Å—Ç–≤–∏—è: {', '.join(actions)}")
    except Exception as e:
        logger.debug(f"Failed to get event data: {e}")

    try:
        from src.session import get_client_profile
        profile = get_client_profile(user_id)
        if profile:
            profile_parts = []
            if profile.get("industry"):
                profile_parts.append(f"–û—Ç—Ä–∞—Å–ª—å: {profile['industry']}")
            if profile.get("budget_range"):
                profile_parts.append(f"–ë—é–¥–∂–µ—Ç: {profile['budget_range']}")
            if profile.get("timeline"):
                profile_parts.append(f"–°—Ä–æ–∫–∏: {profile['timeline']}")
            if profile.get("needs"):
                profile_parts.append(f"–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏: {profile['needs']}")
            if profile.get("objections"):
                profile_parts.append(f"–í–æ–∑—Ä–∞–∂–µ–Ω–∏—è: {profile['objections']}")
            if profile_parts:
                context_parts.append("[–î–û–õ–ì–û–°–†–û–ß–ù–´–ô –ü–†–û–§–ò–õ–¨]\n" + "\n".join(profile_parts))
    except Exception as e:
        logger.debug(f"Failed to get client profile: {e}")

    if context_parts:
        return "\n".join(context_parts)
    return ""


def build_objection_hint(user_message: str) -> str:
    objections = detect_objections(user_message)
    if not objections:
        return ""

    hints = []
    for obj in objections:
        if obj in OBJECTION_STRATEGIES:
            hints.append(OBJECTION_STRATEGIES[obj])

    return "\n".join(hints)


def build_emotion_hint(user_message: str) -> str:
    emotions = detect_emotions(user_message)
    if not emotions:
        return ""

    hints = []
    for emo in emotions:
        if emo in EMOTION_HINTS:
            hints.append(EMOTION_HINTS[emo])

    return "\n".join(hints)


def build_full_context(user_id: int, user_message: str, username: str = None, first_name: str = None, message_count: int = 0) -> Optional[str]:
    parts = []

    try:
        from src.rag import get_relevant_knowledge
        rag_context = get_relevant_knowledge(user_message, limit=5)
        if rag_context:
            parts.append(rag_context)
    except Exception as e:
        logger.debug(f"RAG knowledge retrieval skipped: {e}")

    client_ctx = build_client_context(user_id, username, first_name)
    if client_ctx:
        parts.append(client_ctx)

    client_style = detect_client_style(user_message, message_count)
    if client_style:
        parts.append(f"\n[–°–¢–ò–õ–¨ –ö–õ–ò–ï–ù–¢–ê]\n{client_style}")

    funnel_stage = detect_funnel_stage(user_id, user_message, message_count)
    stage_info = FUNNEL_STAGE_SIGNALS.get(funnel_stage, {})
    if stage_info.get("instruction"):
        parts.append(f"\n[–°–¢–ê–î–ò–Ø –í–û–†–û–ù–ö–ò]\n{stage_info['instruction']}")

    try:
        from src.propensity import propensity_scorer
        score = propensity_scorer.get_score(user_id)
        if score is not None:
            if score >= 70:
                parts.append(f"\n[PROPENSITY SCORE: {score}/100 ‚Äî –ì–û–†–Ø–ß–ò–ô]\n–ö–ª–∏–µ–Ω—Ç —Å –≤—ã—Å–æ–∫–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é –ø–æ–∫—É–ø–∫–∏. –î–µ–π—Å—Ç–≤—É–π —Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ: –ø—Ä–µ–¥–ª–∞–≥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–±—Ä–∏—Ñ, –æ–ø–ª–∞—Ç–∞, —Å–æ–∑–≤–æ–Ω).")
            elif score >= 40:
                parts.append(f"\n[PROPENSITY SCORE: {score}/100 ‚Äî –¢–Å–ü–õ–´–ô]\n–ö–ª–∏–µ–Ω—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω. –£—Å–∏–ª–∏–≤–∞–π —Ü–µ–Ω–Ω–æ—Å—Ç—å, –ø–æ–∫–∞–∑—ã–≤–∞–π –∫–µ–π—Å—ã, –ø—Ä–µ–¥–ª–∞–≥–∞–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä.")
            elif score >= 20:
                parts.append(f"\n[PROPENSITY SCORE: {score}/100 ‚Äî –ü–†–û–ì–†–ï–í–ê–ï–¢–°–Ø]\n–ö–ª–∏–µ–Ω—Ç –∏–∑—É—á–∞–µ—Ç. –î–∞–≤–∞–π –ø–æ–ª–µ–∑–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –Ω–µ –¥–∞–≤–∏.")
    except Exception as e:
        logger.debug(f"Propensity scoring skipped: {e}")

    objections = detect_objections(user_message)
    objection_hint = build_objection_hint(user_message)
    if objection_hint:
        parts.append(f"\n[–û–ë–ù–ê–†–£–ñ–ï–ù–û –í–û–ó–†–ê–ñ–ï–ù–ò–ï]\n{objection_hint}")

    social_proof = get_social_proof(objections, funnel_stage)
    if social_proof:
        parts.append(f"\n{social_proof}")

    relevant_case = get_relevant_case_study(user_id)
    if relevant_case and funnel_stage in ("consideration", "decision"):
        parts.append(f"\n{relevant_case}")

    emotion_hint = build_emotion_hint(user_message)
    if emotion_hint:
        parts.append(f"\n[–≠–ú–û–¶–ò–û–ù–ê–õ–¨–ù–´–ô –¢–û–ù]\n{emotion_hint}")

    momentum = detect_momentum(user_message)
    if momentum and momentum in MOMENTUM_STRATEGIES:
        parts.append(f"\n[MOMENTUM]\n{MOMENTUM_STRATEGIES[momentum]}")

    proactive = get_proactive_value(user_id, funnel_stage)
    if proactive:
        parts.append(f"\n{proactive}")

    try:
        from src.ab_testing import ab_testing
        dialog_variant = ab_testing.get_variant(user_id, "response_style")
        if dialog_variant == "b":
            parts.append("\n[A/B –°–¢–ò–õ–¨: CASUAL]\n–û—Ç–≤–µ—á–∞–π –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–π ) –∏ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–Ω—ã–π —Å—Ç–∏–ª—å, –∫–∞–∫ –æ–±—â–µ–Ω–∏–µ —Å –¥—Ä—É–≥–æ–º.")
        cta_variant = ab_testing.get_variant(user_id, "cta_style")
        if cta_variant == "b":
            parts.append("\n[A/B CTA: SOFT]\n–ù–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞–ø—Ä—è–º—É—é. –í–º–µ—Å—Ç–æ '–î–∞–≤–∞–π—Ç–µ —Ä–∞—Å—Å—á–∏—Ç–∞—é' ‚Üí '–ö—Å—Ç–∞—Ç–∏, –º–æ–≥—É –ø—Ä–∏–∫–∏–Ω—É—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å, –µ—Å–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ'.")
        objection_variant = ab_testing.get_variant(user_id, "objection_handling")
        if objection_variant == "b":
            parts.append("\n[A/B –í–û–ó–†–ê–ñ–ï–ù–ò–Ø: DATA-FIRST]\n–ü—Ä–∏ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è—Ö –Ω–∞—á–∏–Ω–∞–π —Å —Ü–∏—Ñ—Ä –∏ —Ñ–∞–∫—Ç–æ–≤, –∞ –Ω–µ —Å —ç–º–ø–∞—Ç–∏–∏. –ü—Ä–∏–º–µ—Ä: '–ü–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ, 87% –∫–ª–∏–µ–Ω—Ç–æ–≤ –æ–∫—É–ø–∞—é—Ç –≤–ª–æ–∂–µ–Ω–∏—è –∑–∞ 3 –º–µ—Å—è—Ü–∞' –≤–º–µ—Å—Ç–æ '–ü–æ–Ω–∏–º–∞—é –≤–∞—à–∏ —Å–æ–º–Ω–µ–Ω–∏—è'.")
        pricing_variant = ab_testing.get_variant(user_id, "pricing_reveal")
        if pricing_variant == "b":
            parts.append("\n[A/B –¶–ï–ù–´: VALUE-FIRST]\n–ù–µ –Ω–∞–∑—ã–≤–∞–π —Ü–µ–Ω—É —Å—Ä–∞–∑—É. –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∂–∏ —Ü–µ–Ω–Ω–æ—Å—Ç—å: –∫–µ–π—Å, ROI, –≤—ã–≥–æ–¥—ã. –¶–µ–Ω—É ‚Äî —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–æ—Å–∏—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ –∏–ª–∏ –ø–æ–ø—Ä–æ—Å–∏—Ç –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫—É.")
        followup_variant = ab_testing.get_variant(user_id, "followup_tone")
        if followup_variant == "b":
            parts.append("\n[A/B –¢–û–ù–ê–õ–¨–ù–û–°–¢–¨: FRIENDLY]\n–û–±—â–∞–π—Å—è –∫–∞–∫ –¥–æ–±—Ä—ã–π –∑–Ω–∞–∫–æ–º—ã–π, –∞ –Ω–µ –∫–∞–∫ –ø—Ä–æ–¥–∞–≤–µ—Ü. –ú–µ–Ω—å—à–µ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–∏, –±–æ–ª—å—à–µ –∑–∞–±–æ—Ç—ã: '–ö–∞–∫ —É –≤–∞—Å –¥–µ–ª–∞ —Å –ø—Ä–æ–µ–∫—Ç–æ–º?' –≤–º–µ—Å—Ç–æ '–•–æ—Ç–µ–ª–∏ –±—ã –≤—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—Å—É–∂–¥–µ–Ω–∏–µ?'.")
    except Exception as e:
        logger.debug(f"A/B dialog testing skipped: {e}")

    social_keywords = ['—Å–æ—Ü—Å–µ—Ç', '–∏–Ω—Å—Ç–∞–≥—Ä–∞–º', '—Ç–∏–∫—Ç–æ–∫', '—é—Ç—É–±', 'youtube', 'instagram', 'tiktok', '–ø–æ–¥–ø–∏—Å', '–º–æ–Ω–µ—Ç', '–∑–∞–¥–∞–Ω', '–±–æ–Ω—É—Å', '—Å–∫–∏–¥–∫']
    if any(kw in user_message.lower() for kw in social_keywords) or funnel_stage in ('awareness', 'interest'):
        try:
            from src.social_links import get_social_context_for_ai
            parts.append(f"\n{get_social_context_for_ai()}")
        except Exception:
            pass

    if parts:
        return "\n".join(parts)
    return None


def get_dynamic_buttons(user_id: int, user_message: str, message_count: int = 0) -> list:
    stage = detect_funnel_stage(user_id, user_message, message_count)
    buttons = DYNAMIC_BUTTONS_BY_STAGE.get(stage, DYNAMIC_BUTTONS_BY_STAGE["awareness"])
    return buttons[:3]


def is_returning_user(user_id: int) -> bool:
    try:
        from src.leads import lead_manager
        lead = lead_manager.get_lead(user_id)
        if lead and hasattr(lead, 'message_count') and lead.message_count and lead.message_count > 5:
            return True
    except Exception:
        pass
    return False


def get_returning_context(user_id: int) -> Optional[str]:
    try:
        from src.session import session_manager
        if user_id in session_manager._sessions:
            session = session_manager._sessions[user_id]
            if session._summary:
                return session._summary
    except Exception:
        pass

    try:
        import os
        DATABASE_URL = os.environ.get("DATABASE_URL")
        if DATABASE_URL:
            from src.database import execute_one
            row = execute_one(
                "SELECT summary FROM conversation_summaries WHERE telegram_id = %s",
                (user_id,), dict_cursor=True
            )
            if row and row.get("summary"):
                return row["summary"]
    except Exception:
        pass
    return None
